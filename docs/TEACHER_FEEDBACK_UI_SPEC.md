# 교사 피드백 워크스페이스 UI/동작 상세 명세

## 1. 목적

- AI가 생성한 피드백(문항별/지표별/통합)을 교사가 검토·수정·첨삭할 수 있게 한다.
- 교사 승인(Approve)된 피드백과 AI 피드백을 **함께 반영하여 최종 PDF 보고서를 생성**한다.
- 수정 과정은 추적 가능해야 하며(감사로그/버전), 승인 후에는 재현성을 위해 스냅샷을 고정한다.

---

## 2. 화면 정보 구조(IA)

### 2.1 좌측 패널: 학생/제출 목록
- 필터
  - 학급/학년/검사 세션
  - 제출 상태: 미응시/진행/제출/무효
  - AI 상태: 대기/완료/실패
  - 교사 상태: Draft/In Review/Approved
  - 최종 PDF: 미생성/생성/실패
- 리스트 표시 항목
  - 학생명(또는 익명ID 정책), 학생ID
  - 제출 시간
  - AI 초안 상태 배지
  - 교사 첨삭 상태 배지
  - 최종 보고서 배지

### 2.2 중앙 패널: 피드백 편집 캔버스(탭)
권장 탭(섹션별 저장/승인 가능):
1) Executive Summary (핵심 요약)
2) Domain Guidance (영역별 지도 방향: 이해력/의사소통/감수성)
3) Item Evidence (문항 근거/오류 유형/미니 피드백)
4) Trait (독자성향 A~D 해석 및 지도 포인트)
5) Book Guidance (도서 기반 지도안: allowlist 기반)
6) Parent Summary (학부모 요약)

### 2.3 우측 패널: 근거/데이터/검증 패널
- 지표 카드
  - 영역 점수/백분위/등급
  - 하위지표 TOP 취약/강점
- 문항 근거
  - 문항ID, 지표(영역/하위지표), 학생 응답, 정답/루브릭, 채점 breakdown
- 도서 후보(allowlist)
  - 후보 목록(필터: 학년군/난이도/태그)
  - 선택/순서 변경
- 검증 상태
  - JSON 스키마 통과 여부
  - PII 포함 여부(정책 기반)
  - 도서 allowlist 위반 여부
  - 승인 가능 여부(조건 충족)

---

## 3. 편집 모드와 표시 정책

### 3.1 AI 초안 표시 방식(모드 선택)
- 모드 A: 병렬 표시(권장)
  - 좌: AI 초안(읽기 전용)
  - 우: 교사 편집본(편집 가능)
- 모드 B: 인라인 수정(Track Changes)
  - AI 본문 기반에서 교사 수정 시 추가/삭제 표시
  - 저장 시 diff_json 생성 권장(JSON Patch 등)

### 3.2 교사 편집본 우선 정책
- 최종 보고서 본문 반영 우선순위
  1) 교사 승인본(Approved)
  2) 교사 초안(Draft) (정책에 따라 ‘초안’ 워터마크)
  3) AI 초안(fallback)

---

## 4. 첨삭(편집) 기능 요구사항

### 4.1 기본 편집 기능
- 리치 텍스트: 문단, 목록, 굵게/밑줄/강조, 인용
- 섹션 단위 저장/불러오기(자동 저장 옵션)

### 4.2 문장 코멘트(주석)
- 문장/문단 선택 → 코멘트 작성
- 코멘트 공개 범위
  - 교사용 내부(학생/학부모에 숨김)
  - 보고서 반영(표시/숨김 선택)

### 4.3 템플릿 스니펫 삽입
- 규칙 기반 문장 템플릿 라이브러리
  - 예: “비판적 이해 지도 문장”, “가정 연계 활동”, “서술형 답안 개선 팁”
- 스니펫 삽입 시, 근거 지표/문항 링크 메타를 자동 첨부(선택)

### 4.4 근거 링크(Traceability)
- 버튼 클릭으로 아래 메타데이터를 삽입/연결
  - reference_items: [item_id...]
  - reference_subskills: [subskill_id...]
  - reference_domains: [domain_id...]
- PDF에는 노출하지 않되, 내부적으로는 저장하여 “문장 ↔ 근거” 역추적 가능하게 한다.

---

## 5. AI 재생성(부분 재생성) 정책

### 5.1 섹션 단위 재생성
- 버튼: “이 섹션만 AI 재생성”
- 교사가 추가 지시문(instruction)을 입력할 수 있음
- 재생성 결과는 “대안 카드(variants)”로 누적
  - 기존 교사 편집본을 덮어쓰지 않음
  - 교사가 채택/부분 복사 가능

### 5.2 재생성 시 입력 데이터
- 해당 섹션에 필요한 최소 데이터만 제공(프라이버시/비용/일관성)
- 항목별 분석 → 영역 합성 → 통합 합성의 파이프라인 산출물을 재사용(캐시)

---

## 6. 도서 기반 지도안 편집(Allowlist 강제)

### 6.1 입력 제약
- 추천 도서 후보는 `book_id` 기반으로만 취급한다.
- 후보 목록은 `book_catalog(allowlist)`에서 제공된 데이터만 사용한다.

### 6.2 교사 편집
- 교사는 후보에서 선택/순서 변경 가능
- 도서별 활동/질문 프롬프트(AI 생성)를 교사가 수정 가능

### 6.3 위반 탐지/차단(권장 강제 정책)
- 본문에 등록되지 않은 도서명/도서ID가 텍스트로 등장하면 경고 표시
- 정책 옵션
  - Soft: 경고만 표시하고 저장 허용, 승인 단계에서 차단
  - Hard: 저장 단계에서 차단
- 승인 시 반드시 allowlist 검증을 통과해야 한다.

---

## 7. 승인(Approve) 및 잠금(Lock)

### 7.1 상태 전이
- Draft → (선택) In Review → Approved
- Approved 이후
  - 편집 불가(잠금)
  - 상위 권한(SchoolManager 또는 Admin)만 승인 해제 가능(정책)

### 7.2 승인 시 스냅샷 고정(재현성)
- 교사 피드백 승인본(content_json) 저장
- diff_json, approved_at, approved_by 저장
- 해당 제출물의 AI 산출물 버전(모델/프롬프트/스키마 버전)도 함께 고정
- 최종 PDF는 “승인본 스냅샷”을 참조해 재생성 가능해야 한다.

---

## 8. 최종 보고서 반영 규칙(AI + 교사)

### 8.1 기본 반영 정책(권장)
- 학생/학부모용: 교사 승인본을 본문에 반영, AI는 “참고 섹션”으로 별도 수록(선택)
- 교사용 내부 보고서: AI/교사 병기(2열) 옵션 허용(선택)

### 8.2 병합 규칙(요약)
- 교사 승인본이 있는 항목은 교사본을 우선 반영
- 교사 항목이 비어있으면 AI를 fallback로 반영 가능(옵션)
- 병합 결과는 리포트 버전으로 저장한다.

---

## 9. 감사로그/이력

필수 로깅:
- 누가/언제/어떤 섹션을/어떻게 변경했는지(저장/승인/승인해제/재생성/다운로드)
- 교사 피드백 버전 히스토리(승인본 immutable 권장)
- 최종 PDF가 사용한 데이터 스냅샷 식별자 기록
