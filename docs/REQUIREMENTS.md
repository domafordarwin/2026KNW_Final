# 요구사항 정의서 (Requirements Definition)

## 1. 목적 및 범위
본 시스템은 온라인 문해력(독해력) 및 독자 성향(A~D) 진단을 수행하고, 결과를 분석하여 학생별/학교별 PDF 보고서를 생성·배포한다. 분석·추론·피드백 생성은 OpenAI 기반 LLM을 활용하되, **항목별(문항/하위지표/영역) 처리 후 통합 합성**하는 파이프라인을 통해 일관성과 구체성을 확보한다. 추천 도서 및 독서 지도 제안은 **관리자(운영자)가 제공하는 도서 Allowlist**에 근거해서만 생성한다.

### 포함 범위
- 문항/지문/정답/루브릭 등록 및 검사 버전 발행(관리자)
- 추천 도서 Allowlist 등록(관리자)
- 역할 기반 메뉴/권한(관리자/학교담당자/검사진행교사/학생/학부모)
- 검사 세션 생성·배부·응시·제출
- 자동 채점/루브릭 기반 채점 및 지표 산출
- LLM 기반 항목별 분석/통합 피드백 생성
- 교사 검수·첨삭·승인(Approve) 워크플로
- 학생별/학교별 보고서(온라인 열람 + PDF 다운로드)
- 학부모 공유 링크(토큰/만료)
- 감사로그/접근통제/PII 최소화

### 제외 범위(초기)
- 외부 LMS(NEIS 등) 완전 자동 연동(추후)
- 오프라인 인쇄 대행/배송(추후)

---

## 2. 사용자 역할(Role) 및 권한
| 역할 | 핵심 권한 |
|---|---|
| Admin | 문항 은행/검사 버전 관리, 도서 Allowlist 관리, 시스템 정책(모델/프롬프트 버전) |
| SchoolManager(학교 담당자) | 학생 ID/계정 관리(일괄 업로드/초기화), 학교 단위 결과/학교 보고서 출력 |
| Teacher(검사 진행 교사) | 검사 배부/진행관리, 학생 기록관리, AI 피드백 검수·수정·첨삭, 최종 승인, 학생별 보고서 생성/공유 |
| Student | 검사 응시/제출, 개인 보고서 열람/다운로드(허용 시) |
| Parent | 자녀 보고서 열람/다운로드(공유 토큰 또는 계정 연동) |

---

## 3. 메뉴(내비게이션) 요구사항

### 3.1 관리자 페이지(Admin Console)
- 문항 관리
  - 지문/문항 등록(CRUD), 검색/필터(학년군/영역/하위지표/난이도/유형)
  - 정답키/루브릭 등록, 누락/포맷 검증
  - 검사 버전 발행(스냅샷 고정)
- 추천 도서 관리(Allowlist)
  - 도서 CRUD, CSV 업로드/검증, 활성/비활성
  - 추천 정책: “목록 외 추천 금지” 강제
- (옵션) LLM 정책
  - 모델/프롬프트 버전, 레이트리밋, 스키마 검증, 실패 fallback 정책

### 3.2 교사 페이지(Teacher Portal) — 역할 분리

#### A) 학교 담당자(SchoolManager)
- 학생 계정/학급 관리(일괄 업로드, 초기화, 재적)
- 학교 대시보드(영역/하위지표/성향 분포)
- 학교 전체 보고서 생성/열람/다운로드(PDF)
- (옵션) 교사 권한/학급 접근 범위 관리

#### B) 검사 진행 교사(Teacher)
- 검사 운영: 세션 생성/배부(코드·링크·QR), 진행 현황, 재응시 정책
- 학생 기록 관리: 응시 상태, 제출 잠금/해제, 재응시 승인
- 피드백 워크스페이스
  - AI 피드백(초안) 열람
  - 교사 검수/수정/첨삭(변경 추적)
  - 섹션 단위 AI 재생성(대안 카드)
  - 승인(Approve) 후 잠금(Lock)
- 보고서
  - 학생별 최종 보고서 생성/미리보기/다운로드
  - 학부모 공유 링크 발급(만료 설정)

### 3.3 학생/학부모 페이지
- 검사 응시(학생)
- 보고서 열람(PDF 뷰어) 및 다운로드(PDF)
- 공유 링크(학부모) 접근/만료 처리

---

## 4. 핵심 기능 요구사항(Functional Requirements)

### FR-01 검사 및 응답
- 검사 세션 생성(버전, 학급, 기간, 재응시 정책)
- 학생 응시 진행/임시저장/제출
- 제출 후 수정 방지(정책에 따른 예외)

### FR-02 채점 및 지표 산출
- 선택형 자동 채점
- 서술형 루브릭 채점(요소별 breakdown 저장)
- 영역/하위지표 점수 및 백분위/등급 산출
- 독자성향(A~D) 유형은 **규칙 기반 판정**(LLM은 설명문 생성만)

### FR-03 LLM 분석/피드백 파이프라인
- 항목별 처리 → 통합 합성 단계로 수행
  - Step1: 문항 단위 분석(Item Analyzer)
  - Step2: 하위지표/영역 합성(Synthesizer)
  - Step3: 성향 해석(Trait Explanation; 유형 고정)
  - Step4: 통합 요약/지도 방향(Integrated Composer)
  - (집계형) School Synthesis
- 모든 LLM 출력은 JSON 스키마 검증을 통과해야 저장/반영 가능
- 실패 시 규칙 기반 최소 문장(fallback)으로 보고서 생성이 중단되지 않아야 함

### FR-04 교사 검수/첨삭 및 승인
- AI 초안 + 교사 편집본 병렬 표시/인라인 수정
- 문장 코멘트(주석), 공개 범위 설정
- 섹션 단위 저장 및 섹션 단위 AI 재생성(대안 카드)
- 승인(Approve) 후 잠금(Lock)
- 최종 보고서에는 AI 피드백과 교사 피드백을 함께 반영(정책 기반)

### FR-05 추천 도서/독서 지도(Allowlist)
- 추천 도서 후보는 반드시 `book_catalog(active=true)`에서만
- LLM은 후보 book_id 집합 내에서만 선택 가능
- allowlist 위반 시 재시도 후 규칙 기반 대체

### FR-06 보고서 생성/배포
- 학생별 보고서 + 학교 전체 보고서 생성
- 온라인 열람(PDF.js 등) + PDF 다운로드(signed URL)
- 공유 링크(학부모) 발급/만료/접근 통제

---

## 5. 비기능 요구사항(NFR)
- 보안: RBAC, 감사로그, 다운로드 URL 만료, PII 분리/암호화(선택)
- 성능: 제출 직후 사용자 응답은 즉시, 분석/리포트는 비동기 처리
- 가용성: LLM 장애 시 fallback 생성
- 재현성: 승인본 스냅샷+모델/프롬프트/템플릿 버전 고정
- 확장성: 워커 수평 확장, 집계 DB 분리 가능
