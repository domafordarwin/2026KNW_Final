  [1m[35m (3.7ms)[0m  [1m[35mCREATE TABLE "schema_migrations" ("version" varchar NOT NULL PRIMARY KEY)[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "ar_internal_metadata" ("key" varchar NOT NULL PRIMARY KEY, "value" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "environment"]]
  [1m[36mActiveRecord::InternalMetadata Create (3.5ms)[0m  [1m[32mINSERT INTO "ar_internal_metadata" ("key", "value", "created_at", "updated_at") VALUES ('environment', 'test', '2026-01-16 04:50:30.718476', '2026-01-16 04:50:30.718479') RETURNING "key"[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
Migrating to CreateCoreTables (20260116020000)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.5ms)[0m  [1m[35mCREATE TABLE "users" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "role" varchar NOT NULL, "status" varchar DEFAULT 'active' NOT NULL, "name" varchar NOT NULL, "email_optional" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_users_on_email_optional" ON "users" ("email_optional")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "schools" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "classes" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "school_id" integer NOT NULL, "grade" varchar NOT NULL, "name" varchar NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_ad8ff242c3"
FOREIGN KEY ("school_id")
  REFERENCES "schools" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_classes_on_school_id" ON "classes" ("school_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "student_profiles" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "student_id" integer NOT NULL, "school_id" integer NOT NULL, "class_id" integer NOT NULL, "student_code" varchar NOT NULL, "pii_ref_id" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_1716c89783"
FOREIGN KEY ("student_id")
  REFERENCES "users" ("id")
, CONSTRAINT "fk_rails_94501d5f5a"
FOREIGN KEY ("school_id")
  REFERENCES "schools" ("id")
, CONSTRAINT "fk_rails_cca7541598"
FOREIGN KEY ("class_id")
  REFERENCES "classes" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_student_profiles_on_student_id" ON "student_profiles" ("student_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_student_profiles_on_school_id" ON "student_profiles" ("school_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_student_profiles_on_class_id" ON "student_profiles" ("class_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_student_profiles_on_school_id_and_student_code" ON "student_profiles" ("school_id", "student_code")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "parent_links" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "parent_user_id" integer NOT NULL, "student_id" integer NOT NULL, "access_token" varchar NOT NULL, "expires_at" datetime(6), "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_3af891c67b"
FOREIGN KEY ("parent_user_id")
  REFERENCES "users" ("id")
, CONSTRAINT "fk_rails_16356b69e6"
FOREIGN KEY ("student_id")
  REFERENCES "users" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_parent_links_on_parent_user_id" ON "parent_links" ("parent_user_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_parent_links_on_student_id" ON "parent_links" ("student_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_parent_links_on_access_token" ON "parent_links" ("access_token")[0m
  [1m[35m (0.4ms)[0m  [1m[35mCREATE TABLE "passages" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "title" varchar NOT NULL, "text" text NOT NULL, "grade_band" varchar, "tags_json" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "items" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "passage_id" integer, "item_type" varchar NOT NULL, "domain" varchar, "subskill" varchar, "difficulty" varchar, "prompt" text NOT NULL, "choices_json" json, "answer_key_json" json, "rubric_json" json, "points" integer DEFAULT 1 NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_d63ad2c3e0"
FOREIGN KEY ("passage_id")
  REFERENCES "passages" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_items_on_passage_id" ON "items" ("passage_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "assessment_versions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "name" varchar NOT NULL, "status" varchar NOT NULL, "published_at" datetime(6), "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "assessment_version_items" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "assessment_version_id" integer NOT NULL, "item_id" integer NOT NULL, "order_no" integer NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_0dc796acf5"
FOREIGN KEY ("assessment_version_id")
  REFERENCES "assessment_versions" ("id")
, CONSTRAINT "fk_rails_967a97f87f"
FOREIGN KEY ("item_id")
  REFERENCES "items" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_assessment_version_items_on_assessment_version_id" ON "assessment_version_items" ("assessment_version_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_assessment_version_items_on_item_id" ON "assessment_version_items" ("item_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_assessment_version_items_on_version_and_item" ON "assessment_version_items" ("assessment_version_id", "item_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "sessions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "school_id" integer NOT NULL, "class_id" integer NOT NULL, "assessment_version_id" integer NOT NULL, "created_by_teacher_id" integer NOT NULL, "start_at" datetime(6), "end_at" datetime(6), "status" varchar NOT NULL, "access_code" varchar NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_ac93d7a537"
FOREIGN KEY ("school_id")
  REFERENCES "schools" ("id")
, CONSTRAINT "fk_rails_25a1741b2d"
FOREIGN KEY ("class_id")
  REFERENCES "classes" ("id")
, CONSTRAINT "fk_rails_a79e92fd6a"
FOREIGN KEY ("assessment_version_id")
  REFERENCES "assessment_versions" ("id")
, CONSTRAINT "fk_rails_9ad6e07977"
FOREIGN KEY ("created_by_teacher_id")
  REFERENCES "users" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_sessions_on_school_id" ON "sessions" ("school_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_sessions_on_class_id" ON "sessions" ("class_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_sessions_on_assessment_version_id" ON "sessions" ("assessment_version_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_sessions_on_created_by_teacher_id" ON "sessions" ("created_by_teacher_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_sessions_on_access_code" ON "sessions" ("access_code")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "submissions" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "session_id" integer NOT NULL, "student_id" integer NOT NULL, "started_at" datetime(6), "submitted_at" datetime(6), "status" varchar NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_a2cfd0f432"
FOREIGN KEY ("session_id")
  REFERENCES "sessions" ("id")
, CONSTRAINT "fk_rails_19447e9b4d"
FOREIGN KEY ("student_id")
  REFERENCES "users" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_submissions_on_session_id" ON "submissions" ("session_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_submissions_on_student_id" ON "submissions" ("student_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_submissions_on_session_id_and_student_id" ON "submissions" ("session_id", "student_id")[0m
  [1m[35m (0.2ms)[0m  [1m[35mCREATE TABLE "responses" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "item_id" integer NOT NULL, "answer_json" json, "time_spent" integer, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_4b926f0062"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
, CONSTRAINT "fk_rails_5e194140c8"
FOREIGN KEY ("item_id")
  REFERENCES "items" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_responses_on_submission_id" ON "responses" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_responses_on_item_id" ON "responses" ("item_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "scoring_results" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "item_id" integer NOT NULL, "score" integer DEFAULT 0 NOT NULL, "is_correct" boolean DEFAULT FALSE NOT NULL, "rubric_breakdown_json" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_2f753cb553"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
, CONSTRAINT "fk_rails_1b3927129b"
FOREIGN KEY ("item_id")
  REFERENCES "items" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_scoring_results_on_submission_id" ON "scoring_results" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_scoring_results_on_item_id" ON "scoring_results" ("item_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "metrics_results" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "domain_scores_json" json, "subskill_scores_json" json, "percentile_json" json, "computed_at" datetime(6), "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_88e7531ca3"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_metrics_results_on_submission_id" ON "metrics_results" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "trait_results" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "trait_type" varchar NOT NULL, "trait_scores_json" json, "computed_at" datetime(6), "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_04d595cf11"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_trait_results_on_submission_id" ON "trait_results" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "ai_feedback_runs" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "step" varchar NOT NULL, "model" varchar NOT NULL, "prompt_version" varchar NOT NULL, "input_hash" varchar NOT NULL, "output_json" json, "status" varchar NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_f8c1480156"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_ai_feedback_runs_on_submission_id" ON "ai_feedback_runs" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_ai_feedback_runs_on_submission_step_hash" ON "ai_feedback_runs" ("submission_id", "step", "input_hash")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "ai_feedback_compiled" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "compiled_json" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_b470a7fd38"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_ai_feedback_compiled_on_submission_id" ON "ai_feedback_compiled" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "teacher_feedback" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "editor_teacher_id" integer NOT NULL, "content_json" json, "diff_json" json, "status" varchar DEFAULT 'draft' NOT NULL, "approved_at" datetime(6), "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_719034847f"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
, CONSTRAINT "fk_rails_5e3775677a"
FOREIGN KEY ("editor_teacher_id")
  REFERENCES "users" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_teacher_feedback_on_submission_id" ON "teacher_feedback" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_teacher_feedback_on_editor_teacher_id" ON "teacher_feedback" ("editor_teacher_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "feedback_audit" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "teacher_feedback_id" integer NOT NULL, "actor_id" integer NOT NULL, "action" varchar NOT NULL, "meta_json" json, "timestamp" datetime(6) NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_0677fa0cb0"
FOREIGN KEY ("teacher_feedback_id")
  REFERENCES "teacher_feedbacks" ("id")
, CONSTRAINT "fk_rails_51f3ee417e"
FOREIGN KEY ("actor_id")
  REFERENCES "users" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_feedback_audit_on_teacher_feedback_id" ON "feedback_audit" ("teacher_feedback_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_feedback_audit_on_actor_id" ON "feedback_audit" ("actor_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "reports" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "scope" varchar NOT NULL, "submission_id" integer, "session_id" integer, "version" varchar NOT NULL, "status" varchar NOT NULL, "template_version" varchar NOT NULL, "storage_key" varchar, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_31d0219a88"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
, CONSTRAINT "fk_rails_e847950771"
FOREIGN KEY ("session_id")
  REFERENCES "sessions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_reports_on_submission_id" ON "reports" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_reports_on_session_id" ON "reports" ("session_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_reports_on_scope_and_submission_id" ON "reports" ("scope", "submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_reports_on_scope_and_session_id" ON "reports" ("scope", "session_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "report_access" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "report_id" integer NOT NULL, "subject_user_id" integer, "access_token" varchar, "can_view" boolean DEFAULT TRUE NOT NULL, "can_download" boolean DEFAULT TRUE NOT NULL, "expires_at" datetime(6), "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_651277ab60"
FOREIGN KEY ("report_id")
  REFERENCES "reports" ("id")
, CONSTRAINT "fk_rails_ecbac7708a"
FOREIGN KEY ("subject_user_id")
  REFERENCES "users" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_report_access_on_report_id" ON "report_access" ("report_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_report_access_on_subject_user_id" ON "report_access" ("subject_user_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE UNIQUE INDEX "index_report_access_on_access_token" ON "report_access" ("access_token")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "book_catalog" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "isbn" varchar, "title" varchar NOT NULL, "author" varchar, "grade_band" varchar, "difficulty" varchar, "tags_json" json, "active" boolean DEFAULT TRUE NOT NULL, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_book_catalog_on_active" ON "book_catalog" ("active")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "book_candidates" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "candidate_book_ids_json" json, "generated_at" datetime(6), "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_d57e6c6442"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_book_candidates_on_submission_id" ON "book_candidates" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "book_guidance" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "submission_id" integer NOT NULL, "selected_book_ids_json" json, "guidance_json" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_a7043da466"
FOREIGN KEY ("submission_id")
  REFERENCES "submissions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_book_guidance_on_submission_id" ON "book_guidance" ("submission_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "analytics_domain_agg" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "session_id" integer NOT NULL, "class_id" integer, "domain" varchar NOT NULL, "avg" float, "std" float, "dist_json" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_54bfb813d4"
FOREIGN KEY ("session_id")
  REFERENCES "sessions" ("id")
, CONSTRAINT "fk_rails_153e2f81b1"
FOREIGN KEY ("class_id")
  REFERENCES "classes" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_analytics_domain_agg_on_session_id" ON "analytics_domain_agg" ("session_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_analytics_domain_agg_on_class_id" ON "analytics_domain_agg" ("class_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "analytics_subskill_agg" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "session_id" integer NOT NULL, "subskill" varchar NOT NULL, "avg" float, "dist_json" json, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_6e6793699f"
FOREIGN KEY ("session_id")
  REFERENCES "sessions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_analytics_subskill_agg_on_session_id" ON "analytics_subskill_agg" ("session_id")[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE TABLE "analytics_trait_agg" ("id" integer PRIMARY KEY AUTOINCREMENT NOT NULL, "session_id" integer NOT NULL, "trait_type" varchar NOT NULL, "ratio" float, "created_at" datetime(6) NOT NULL, "updated_at" datetime(6) NOT NULL, CONSTRAINT "fk_rails_33cac60af6"
FOREIGN KEY ("session_id")
  REFERENCES "sessions" ("id")
)[0m
  [1m[35m (0.1ms)[0m  [1m[35mCREATE INDEX "index_analytics_trait_agg_on_session_id" ON "analytics_trait_agg" ("session_id")[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.1ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20260116020000') RETURNING "version"[0m
  [1m[36mTRANSACTION (2.6ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
Migrating to AddPasswordToUsers (20260116030000)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN immediate TRANSACTION[0m
  [1m[35m (0.7ms)[0m  [1m[35mALTER TABLE "users" ADD "password_digest" varchar[0m
  [1m[36mActiveRecord::SchemaMigration Create (0.1ms)[0m  [1m[32mINSERT INTO "schema_migrations" ("version") VALUES ('20260116030000') RETURNING "version"[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mCOMMIT TRANSACTION[0m
  [1m[36mActiveRecord::SchemaMigration Load (0.0ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ShortAnswerScorerTest: test_rubric_breakdown_includes_keyword_info
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
ShortAnswerScorerTest: test_partial_match_scores_partial_points
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ShortAnswerScorerTest: test_full_match_scores_full_points
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ShortAnswerScorerTest: test_no_match_scores_zero
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
ShortAnswerScorerTest: test_handles_comma-separated_answer_key
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ScoringServiceTest: test_scores_short_answer_with_keyword_matching
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.5ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:50:50.645861"], ["updated_at", "2026-01-16 04:50:50.645861"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.5ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:50:50.715862"], ["updated_at", "2026-01-16 04:50:50.715862"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:50.750994"], ["updated_at", "2026-01-16 04:50:50.750994"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:50.753747"], ["updated_at", "2026-01-16 04:50:50.753747"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:50:50.761277"], ["updated_at", "2026-01-16 04:50:50.761277"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.5ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:50:50.763591"], ["updated_at", "2026-01-16 04:50:50.763591"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:50:50.765791"], ["updated_at", "2026-01-16 04:50:50.765791"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:50:50.773825"], ["updated_at", "2026-01-16 04:50:50.773825"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:50:50.783788"], ["updated_at", "2026-01-16 04:50:50.783788"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:50:50.785313"], ["updated_at", "2026-01-16 04:50:50.785313"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.6ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:50:50.796066"], ["updated_at", "2026-01-16 04:50:50.796066"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:50:50.804579"], ["submitted_at", "2026-01-16 04:50:50.804627"], ["status", "submitted"], ["created_at", "2026-01-16 04:50:50.808457"], ["updated_at", "2026-01-16 04:50:50.808457"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.3ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"The meaning of the word is clear\""], ["time_spent", nil], ["created_at", "2026-01-16 04:50:50.817418"], ["updated_at", "2026-01-16 04:50:50.817418"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 04:50:50.973038"], ["updated_at", "2026-01-16 04:50:50.973038"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.4ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:50:51.004319"], ["created_at", "2026-01-16 04:50:51.004598"], ["updated_at", "2026-01-16 04:50:51.004598"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "C"], ["trait_scores_json", "{\"comprehension\":0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:50:51.012238"], ["created_at", "2026-01-16 04:50:51.012506"], ["updated_at", "2026-01-16 04:50:51.012506"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_incorrectly
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.4ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:50:51.016770"], ["updated_at", "2026-01-16 04:50:51.016770"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.3ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:50:51.018522"], ["updated_at", "2026-01-16 04:50:51.018522"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.021759"], ["updated_at", "2026-01-16 04:50:51.021759"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.024850"], ["updated_at", "2026-01-16 04:50:51.024850"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:50:51.026529"], ["updated_at", "2026-01-16 04:50:51.026529"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:50:51.028252"], ["updated_at", "2026-01-16 04:50:51.028252"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.7ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:50:51.030051"], ["updated_at", "2026-01-16 04:50:51.030051"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:50:51.032874"], ["updated_at", "2026-01-16 04:50:51.032874"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:50:51.034600"], ["updated_at", "2026-01-16 04:50:51.034600"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:50:51.036230"], ["updated_at", "2026-01-16 04:50:51.036230"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:50:51.038113"], ["updated_at", "2026-01-16 04:50:51.038113"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:50:51.039521"], ["submitted_at", "2026-01-16 04:50:51.039551"], ["status", "submitted"], ["created_at", "2026-01-16 04:50:51.039868"], ["updated_at", "2026-01-16 04:50:51.039868"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.3ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"A\""], ["time_spent", nil], ["created_at", "2026-01-16 04:50:51.041797"], ["updated_at", "2026-01-16 04:50:51.041797"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:50:51.054376"], ["updated_at", "2026-01-16 04:50:51.054376"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.4ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0}"], ["subskill_scores_json", "{\"main_idea\":0.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:50:51.058768"], ["created_at", "2026-01-16 04:50:51.059044"], ["updated_at", "2026-01-16 04:50:51.059044"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.2ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.6ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "D"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:50:51.061833"], ["created_at", "2026-01-16 04:50:51.062130"], ["updated_at", "2026-01-16 04:50:51.062130"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
ScoringServiceTest: test_calculates_metrics_result
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.4ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:50:51.067189"], ["updated_at", "2026-01-16 04:50:51.067189"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:50:51.068998"], ["updated_at", "2026-01-16 04:50:51.068998"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.072262"], ["updated_at", "2026-01-16 04:50:51.072262"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.075439"], ["updated_at", "2026-01-16 04:50:51.075439"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.6ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:50:51.077062"], ["updated_at", "2026-01-16 04:50:51.077062"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.6ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:50:51.079929"], ["updated_at", "2026-01-16 04:50:51.079929"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.5ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:50:51.082629"], ["updated_at", "2026-01-16 04:50:51.082629"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:50:51.085103"], ["updated_at", "2026-01-16 04:50:51.085103"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:50:51.087723"], ["updated_at", "2026-01-16 04:50:51.087723"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:50:51.090210"], ["updated_at", "2026-01-16 04:50:51.090210"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.5ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:50:51.092797"], ["updated_at", "2026-01-16 04:50:51.092797"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.4ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:50:51.094725"], ["submitted_at", "2026-01-16 04:50:51.094772"], ["status", "submitted"], ["created_at", "2026-01-16 04:50:51.095233"], ["updated_at", "2026-01-16 04:50:51.095233"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.6ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:50:51.097622"], ["updated_at", "2026-01-16 04:50:51.097622"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.5ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning definition\""], ["time_spent", nil], ["created_at", "2026-01-16 04:50:51.100315"], ["updated_at", "2026-01-16 04:50:51.100315"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:50:51.104776"], ["updated_at", "2026-01-16 04:50:51.104776"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 2], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":2,\"match_ratio\":1.0}"], ["created_at", "2026-01-16 04:50:51.107068"], ["updated_at", "2026-01-16 04:50:51.107068"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0,\"vocabulary\":100.0}"], ["subskill_scores_json", "{\"main_idea\":0.0,\"context_clues\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:50:51.111376"], ["created_at", "2026-01-16 04:50:51.111614"], ["updated_at", "2026-01-16 04:50:51.111614"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.2ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.4ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "C"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":100.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:50:51.114513"], ["created_at", "2026-01-16 04:50:51.114927"], ["updated_at", "2026-01-16 04:50:51.114927"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_correctly
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.4ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:50:51.119505"], ["updated_at", "2026-01-16 04:50:51.119505"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.3ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:50:51.121292"], ["updated_at", "2026-01-16 04:50:51.121292"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.124439"], ["updated_at", "2026-01-16 04:50:51.124439"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.127484"], ["updated_at", "2026-01-16 04:50:51.127484"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.7ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:50:51.128918"], ["updated_at", "2026-01-16 04:50:51.128918"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.4ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:50:51.131882"], ["updated_at", "2026-01-16 04:50:51.131882"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:50:51.134097"], ["updated_at", "2026-01-16 04:50:51.134097"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:50:51.135694"], ["updated_at", "2026-01-16 04:50:51.135694"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:50:51.137297"], ["updated_at", "2026-01-16 04:50:51.137297"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:50:51.138865"], ["updated_at", "2026-01-16 04:50:51.138865"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:50:51.140593"], ["updated_at", "2026-01-16 04:50:51.140593"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:50:51.142091"], ["submitted_at", "2026-01-16 04:50:51.142114"], ["status", "submitted"], ["created_at", "2026-01-16 04:50:51.142406"], ["updated_at", "2026-01-16 04:50:51.142406"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:50:51.144180"], ["updated_at", "2026-01-16 04:50:51.144180"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:50:51.147700"], ["updated_at", "2026-01-16 04:50:51.147700"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0}"], ["subskill_scores_json", "{\"main_idea\":0.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:50:51.152041"], ["created_at", "2026-01-16 04:50:51.152288"], ["updated_at", "2026-01-16 04:50:51.152288"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "D"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:50:51.154654"], ["created_at", "2026-01-16 04:50:51.154866"], ["updated_at", "2026-01-16 04:50:51.154866"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ScoringServiceTest: test_determines_trait_result
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:50:51.158007"], ["updated_at", "2026-01-16 04:50:51.158007"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:50:51.159636"], ["updated_at", "2026-01-16 04:50:51.159636"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.163269"], ["updated_at", "2026-01-16 04:50:51.163269"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.167857"], ["updated_at", "2026-01-16 04:50:51.167857"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.4ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:50:51.169939"], ["updated_at", "2026-01-16 04:50:51.169939"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.4ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:50:51.171836"], ["updated_at", "2026-01-16 04:50:51.171836"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:50:51.173471"], ["updated_at", "2026-01-16 04:50:51.173471"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:50:51.174838"], ["updated_at", "2026-01-16 04:50:51.174838"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:50:51.176277"], ["updated_at", "2026-01-16 04:50:51.176277"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:50:51.177620"], ["updated_at", "2026-01-16 04:50:51.177620"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.5ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:50:51.179612"], ["updated_at", "2026-01-16 04:50:51.179612"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.5ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:50:51.181818"], ["submitted_at", "2026-01-16 04:50:51.181856"], ["status", "submitted"], ["created_at", "2026-01-16 04:50:51.182295"], ["updated_at", "2026-01-16 04:50:51.182295"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:50:51.184638"], ["updated_at", "2026-01-16 04:50:51.184638"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning\""], ["time_spent", nil], ["created_at", "2026-01-16 04:50:51.186555"], ["updated_at", "2026-01-16 04:50:51.186555"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:50:51.191325"], ["updated_at", "2026-01-16 04:50:51.191325"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 04:50:51.194135"], ["updated_at", "2026-01-16 04:50:51.194135"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.3ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.2ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.6ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0,\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"main_idea\":0.0,\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:50:51.200005"], ["created_at", "2026-01-16 04:50:51.200496"], ["updated_at", "2026-01-16 04:50:51.200496"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.4ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "D"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:50:51.203771"], ["created_at", "2026-01-16 04:50:51.204019"], ["updated_at", "2026-01-16 04:50:51.204019"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------
UserTest: test_role_must_be_valid
---------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_role
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_teacher?_returns_true_for_teacher_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
UserTest: test_admin?_returns_true_for_admin_role
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------
UserTest: test_staff?_returns_true_for_admin,_teacher,_school_manager
---------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------
UserTest: test_valid_user_with_all_required_attributes
------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_student?_returns_true_for_student_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------
UserTest: test_password_authentication_works
--------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.232299"], ["updated_at", "2026-01-16 04:50:51.232299"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_name
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
UserTest: test_email_optional_must_be_unique_when_present
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "User1"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:51.238946"], ["updated_at", "2026-01-16 04:50:51.238946"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
SessionsControllerTest: test_successful_login_redirects_to_dashboard
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:52.046173"], ["updated_at", "2026-01-16 04:50:52.046173"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 57ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
SessionsControllerTest: test_failed_login_shows_error
-----------------------------------------------------
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 9.9ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 22.6ms | GC: 0.0ms)
Completed 422 Unprocessable Content in 55ms (Views: 52.4ms | ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
SessionsControllerTest: test_logout_clears_session
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:52.840130"], ["updated_at", "2026-01-16 04:50:52.840130"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started DELETE "/logout" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by SessionsController#destroy as HTML
Redirected to http://www.example.com/login
Completed 302 Found in 78ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------
SessionsControllerTest: test_get_login_page
-------------------------------------------
Started GET "/login" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by SessionsController#new as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 0.4ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 0.7ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 1.1ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_handles_whitespace_in_answer
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_incorrect_answer_scores_zero
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
MultipleChoiceScorerTest: test_handles_nil_answer
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------
MultipleChoiceScorerTest: test_case_insensitive_matching
--------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------
MultipleChoiceScorerTest: test_handles_JSON_object_answer_key
-------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------
MultipleChoiceScorerTest: test_correct_answer_scores_full_points
----------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
Admin::DashboardControllerTest: test_unauthenticated_user_cannot_access_dashboard
---------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:52.936729"], ["updated_at", "2026-01-16 04:50:52.936729"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:13:in 'RoleAuthorization#require_login!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 3ms (Views: 2.1ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Admin::DashboardControllerTest: test_admin_can_access_dashboard
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:52.949766"], ["updated_at", "2026-01-16 04:50:52.949766"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mUser Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "users"[0m
  [1m[36mPassage Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "passages"[0m
  [1m[36mItem Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "items"[0m
  [1m[36mAssessmentVersion Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "assessment_versions"[0m
  [1m[36mBookCatalog Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "book_catalog" WHERE "book_catalog"."active" = ?[0m  [["active", 1]]
  Rendering layout layouts/admin.html.erb
  Rendering admin/dashboard/index.html.erb within layouts/admin
  Rendered admin/dashboard/index.html.erb within layouts/admin (Duration: 0.8ms | GC: 0.0ms)
  Rendered layout layouts/admin.html.erb (Duration: 2.8ms | GC: 0.0ms)
Completed 200 OK in 12ms (Views: 5.2ms | ActiveRecord: 0.4ms (6 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
Admin::DashboardControllerTest: test_non-admin_cannot_access_dashboard
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:52.970128"], ["updated_at", "2026-01-16 04:50:52.970128"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:50:52.972557"], ["updated_at", "2026-01-16 04:50:52.972557"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/teacher
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:50:52 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 2], ["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:19:in 'RoleAuthorization#require_role!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 1ms (Views: 0.3ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
Ai::FeedbackValidatorTest: test_wrong_types_report_errors
---------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
Ai::FeedbackValidatorTest: test_missing_required_keys_reports_errors
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Ai::FeedbackValidatorTest: test_valid_payload_passes_validation
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
Ai::FeedbackValidatorTest: test_non-hash_payload_reports_error
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.2ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------
MultipleChoiceScorerTest: test_correct_answer_scores_full_points
----------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
MultipleChoiceScorerTest: test_handles_nil_answer
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_incorrect_answer_scores_zero
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------
MultipleChoiceScorerTest: test_case_insensitive_matching
--------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_handles_whitespace_in_answer
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------
MultipleChoiceScorerTest: test_handles_JSON_object_answer_key
-------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.4ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
Ai::FeedbackValidatorTest: test_missing_required_keys_reports_errors
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Ai::FeedbackValidatorTest: test_valid_payload_passes_validation
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
Ai::FeedbackValidatorTest: test_wrong_types_report_errors
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
Ai::FeedbackValidatorTest: test_non-hash_payload_reports_error
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
UserTest: test_admin?_returns_true_for_admin_role
-------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_role
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------
UserTest: test_role_must_be_valid
---------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------
UserTest: test_password_authentication_works
--------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.454523"], ["updated_at", "2026-01-16 04:52:26.454523"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_name
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_student?_returns_true_for_student_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------
UserTest: test_staff?_returns_true_for_admin,_teacher,_school_manager
---------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_teacher?_returns_true_for_teacher_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
UserTest: test_email_optional_must_be_unique_when_present
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "User1"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.464009"], ["updated_at", "2026-01-16 04:52:26.464009"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.1ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------
UserTest: test_valid_user_with_all_required_attributes
------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
ScoringServiceTest: test_calculates_metrics_result
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:52:26.473228"], ["updated_at", "2026-01-16 04:52:26.473228"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.5ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:52:26.513283"], ["updated_at", "2026-01-16 04:52:26.513283"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.516584"], ["updated_at", "2026-01-16 04:52:26.516584"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.518883"], ["updated_at", "2026-01-16 04:52:26.518883"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.2ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:52:26.525665"], ["updated_at", "2026-01-16 04:52:26.525665"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:52:26.536571"], ["updated_at", "2026-01-16 04:52:26.536571"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:52:26.538040"], ["updated_at", "2026-01-16 04:52:26.538040"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:52:26.545874"], ["updated_at", "2026-01-16 04:52:26.545874"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:52:26.553458"], ["updated_at", "2026-01-16 04:52:26.553458"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:52:26.554716"], ["updated_at", "2026-01-16 04:52:26.554716"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:52:26.565510"], ["updated_at", "2026-01-16 04:52:26.565510"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:52:26.572117"], ["submitted_at", "2026-01-16 04:52:26.572147"], ["status", "submitted"], ["created_at", "2026-01-16 04:52:26.575743"], ["updated_at", "2026-01-16 04:52:26.575743"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:52:26.583850"], ["updated_at", "2026-01-16 04:52:26.583850"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning definition\""], ["time_spent", nil], ["created_at", "2026-01-16 04:52:26.585312"], ["updated_at", "2026-01-16 04:52:26.585312"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:52:26.624275"], ["updated_at", "2026-01-16 04:52:26.624275"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 2], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":2,\"match_ratio\":1.0}"], ["created_at", "2026-01-16 04:52:26.628424"], ["updated_at", "2026-01-16 04:52:26.628424"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:52:26.642590"], ["created_at", "2026-01-16 04:52:26.642866"], ["updated_at", "2026-01-16 04:52:26.642866"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.2ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:52:26.656901"], ["created_at", "2026-01-16 04:52:26.657354"], ["updated_at", "2026-01-16 04:52:26.657354"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_correctly
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.5ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:52:26.661482"], ["updated_at", "2026-01-16 04:52:26.661482"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.3ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:52:26.663277"], ["updated_at", "2026-01-16 04:52:26.663277"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.666279"], ["updated_at", "2026-01-16 04:52:26.666279"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.668894"], ["updated_at", "2026-01-16 04:52:26.668894"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.2ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:52:26.669980"], ["updated_at", "2026-01-16 04:52:26.669980"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:52:26.671266"], ["updated_at", "2026-01-16 04:52:26.671266"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:52:26.672597"], ["updated_at", "2026-01-16 04:52:26.672597"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:52:26.673914"], ["updated_at", "2026-01-16 04:52:26.673914"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:52:26.675230"], ["updated_at", "2026-01-16 04:52:26.675230"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:52:26.676430"], ["updated_at", "2026-01-16 04:52:26.676430"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:52:26.677932"], ["updated_at", "2026-01-16 04:52:26.677932"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:52:26.679046"], ["submitted_at", "2026-01-16 04:52:26.679071"], ["status", "submitted"], ["created_at", "2026-01-16 04:52:26.679338"], ["updated_at", "2026-01-16 04:52:26.679338"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.3ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:52:26.680892"], ["updated_at", "2026-01-16 04:52:26.680892"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.2ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:52:26.683694"], ["updated_at", "2026-01-16 04:52:26.683694"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.2ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:52:26.686359"], ["created_at", "2026-01-16 04:52:26.686512"], ["updated_at", "2026-01-16 04:52:26.686512"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:52:26.688121"], ["created_at", "2026-01-16 04:52:26.688269"], ["updated_at", "2026-01-16 04:52:26.688269"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_incorrectly
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:52:26.690795"], ["updated_at", "2026-01-16 04:52:26.690795"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.2ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:52:26.691983"], ["updated_at", "2026-01-16 04:52:26.691983"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.694795"], ["updated_at", "2026-01-16 04:52:26.694795"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.697378"], ["updated_at", "2026-01-16 04:52:26.697378"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.2ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:52:26.698418"], ["updated_at", "2026-01-16 04:52:26.698418"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:52:26.699604"], ["updated_at", "2026-01-16 04:52:26.699604"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:52:26.700903"], ["updated_at", "2026-01-16 04:52:26.700903"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:52:26.702104"], ["updated_at", "2026-01-16 04:52:26.702104"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:52:26.703258"], ["updated_at", "2026-01-16 04:52:26.703258"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:52:26.704352"], ["updated_at", "2026-01-16 04:52:26.704352"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.2ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:52:26.705541"], ["updated_at", "2026-01-16 04:52:26.705541"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:52:26.706612"], ["submitted_at", "2026-01-16 04:52:26.706634"], ["status", "submitted"], ["created_at", "2026-01-16 04:52:26.706858"], ["updated_at", "2026-01-16 04:52:26.706858"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"A\""], ["time_spent", nil], ["created_at", "2026-01-16 04:52:26.708319"], ["updated_at", "2026-01-16 04:52:26.708319"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:52:26.711149"], ["updated_at", "2026-01-16 04:52:26.711149"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0}"], ["subskill_scores_json", "{\"main_idea\":0.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:52:26.714240"], ["created_at", "2026-01-16 04:52:26.714459"], ["updated_at", "2026-01-16 04:52:26.714459"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "D"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:52:26.716375"], ["created_at", "2026-01-16 04:52:26.716565"], ["updated_at", "2026-01-16 04:52:26.716565"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ScoringServiceTest: test_scores_short_answer_with_keyword_matching
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:52:26.719144"], ["updated_at", "2026-01-16 04:52:26.719144"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.2ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:52:26.720278"], ["updated_at", "2026-01-16 04:52:26.720278"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.722823"], ["updated_at", "2026-01-16 04:52:26.722823"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.725220"], ["updated_at", "2026-01-16 04:52:26.725220"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:52:26.726197"], ["updated_at", "2026-01-16 04:52:26.726197"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:52:26.727400"], ["updated_at", "2026-01-16 04:52:26.727400"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:52:26.729112"], ["updated_at", "2026-01-16 04:52:26.729112"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:52:26.730755"], ["updated_at", "2026-01-16 04:52:26.730755"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:52:26.731953"], ["updated_at", "2026-01-16 04:52:26.731953"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:52:26.732938"], ["updated_at", "2026-01-16 04:52:26.732938"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:52:26.734165"], ["updated_at", "2026-01-16 04:52:26.734165"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.2ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:52:26.735292"], ["submitted_at", "2026-01-16 04:52:26.735332"], ["status", "submitted"], ["created_at", "2026-01-16 04:52:26.735589"], ["updated_at", "2026-01-16 04:52:26.735589"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.3ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"The meaning of the word is clear\""], ["time_spent", nil], ["created_at", "2026-01-16 04:52:26.736978"], ["updated_at", "2026-01-16 04:52:26.736978"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 04:52:26.739725"], ["updated_at", "2026-01-16 04:52:26.739725"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mMetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.2ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:52:26.742664"], ["created_at", "2026-01-16 04:52:26.742828"], ["updated_at", "2026-01-16 04:52:26.742828"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "C"], ["trait_scores_json", "{\"comprehension\":0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:52:26.744855"], ["created_at", "2026-01-16 04:52:26.745082"], ["updated_at", "2026-01-16 04:52:26.745082"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ScoringServiceTest: test_determines_trait_result
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.2ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:52:26.747760"], ["updated_at", "2026-01-16 04:52:26.747760"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.2ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:52:26.748868"], ["updated_at", "2026-01-16 04:52:26.748868"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.751187"], ["updated_at", "2026-01-16 04:52:26.751187"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:26.753438"], ["updated_at", "2026-01-16 04:52:26.753438"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.2ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:52:26.754507"], ["updated_at", "2026-01-16 04:52:26.754507"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:52:26.755598"], ["updated_at", "2026-01-16 04:52:26.755598"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:52:26.756687"], ["updated_at", "2026-01-16 04:52:26.756687"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:52:26.757786"], ["updated_at", "2026-01-16 04:52:26.757786"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:52:26.758907"], ["updated_at", "2026-01-16 04:52:26.758907"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:52:26.759968"], ["updated_at", "2026-01-16 04:52:26.759968"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:52:26.761894"], ["updated_at", "2026-01-16 04:52:26.761894"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.2ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:52:26.763362"], ["submitted_at", "2026-01-16 04:52:26.763383"], ["status", "submitted"], ["created_at", "2026-01-16 04:52:26.763620"], ["updated_at", "2026-01-16 04:52:26.763620"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:52:26.765145"], ["updated_at", "2026-01-16 04:52:26.765145"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning\""], ["time_spent", nil], ["created_at", "2026-01-16 04:52:26.766311"], ["updated_at", "2026-01-16 04:52:26.766311"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.2ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:52:26.769100"], ["updated_at", "2026-01-16 04:52:26.769100"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.2ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 04:52:26.770523"], ["updated_at", "2026-01-16 04:52:26.770523"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.2ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:52:26.773030"], ["created_at", "2026-01-16 04:52:26.773166"], ["updated_at", "2026-01-16 04:52:26.773166"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "B"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:52:26.774711"], ["created_at", "2026-01-16 04:52:26.774841"], ["updated_at", "2026-01-16 04:52:26.774841"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.0ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ShortAnswerScorerTest: test_full_match_scores_full_points
---------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ShortAnswerScorerTest: test_no_match_scores_zero
------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
ShortAnswerScorerTest: test_partial_match_scores_partial_points
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ShortAnswerScorerTest: test_rubric_breakdown_includes_keyword_info
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
ShortAnswerScorerTest: test_handles_comma-separated_answer_key
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
SessionsControllerTest: test_failed_login_shows_error
-----------------------------------------------------
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 9.6ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 21.8ms | GC: 0.0ms)
Completed 422 Unprocessable Content in 117ms (Views: 52.1ms | ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
SessionsControllerTest: test_logout_clears_session
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:27.317433"], ["updated_at", "2026-01-16 04:52:27.317433"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started DELETE "/logout" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by SessionsController#destroy as HTML
Redirected to http://www.example.com/login
Completed 302 Found in 14ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
SessionsControllerTest: test_successful_login_redirects_to_dashboard
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:27.338869"], ["updated_at", "2026-01-16 04:52:27.338869"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 22ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------
SessionsControllerTest: test_get_login_page
-------------------------------------------
Started GET "/login" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by SessionsController#new as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 0.5ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 0.9ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 1.3ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------
MultipleChoiceScorerTest: test_handles_JSON_object_answer_key
-------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------
MultipleChoiceScorerTest: test_case_insensitive_matching
--------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
MultipleChoiceScorerTest: test_handles_nil_answer
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_handles_whitespace_in_answer
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_incorrect_answer_scores_zero
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------
MultipleChoiceScorerTest: test_correct_answer_scores_full_points
----------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Admin::DashboardControllerTest: test_admin_can_access_dashboard
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:27.375646"], ["updated_at", "2026-01-16 04:52:27.375646"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 3ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mUser Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "users"[0m
  [1m[36mPassage Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "passages"[0m
  [1m[36mItem Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "items"[0m
  [1m[36mAssessmentVersion Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "assessment_versions"[0m
  [1m[36mBookCatalog Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "book_catalog" WHERE "book_catalog"."active" = ?[0m  [["active", 1]]
  Rendering layout layouts/admin.html.erb
  Rendering admin/dashboard/index.html.erb within layouts/admin
  Rendered admin/dashboard/index.html.erb within layouts/admin (Duration: 1.0ms | GC: 0.0ms)
  Rendered layout layouts/admin.html.erb (Duration: 2.6ms | GC: 0.0ms)
Completed 200 OK in 15ms (Views: 6.0ms | ActiveRecord: 0.5ms (6 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
Admin::DashboardControllerTest: test_unauthenticated_user_cannot_access_dashboard
---------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:27.406290"], ["updated_at", "2026-01-16 04:52:27.406290"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:13:in 'RoleAuthorization#require_login!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 5ms (Views: 4.2ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
Admin::DashboardControllerTest: test_non-admin_cannot_access_dashboard
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:27.417742"], ["updated_at", "2026-01-16 04:52:27.417742"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.7ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:52:27.420846"], ["updated_at", "2026-01-16 04:52:27.420846"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/teacher
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:52:27 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 2], ["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:19:in 'RoleAuthorization#require_role!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 1ms (Views: 0.3ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
Admin::DashboardControllerTest: test_unauthenticated_user_cannot_access_dashboard
---------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:07.845283"], ["updated_at", "2026-01-16 04:58:07.845283"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:13:in 'RoleAuthorization#require_login!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 67ms (Views: 10.8ms | ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Admin::DashboardControllerTest: test_admin_can_access_dashboard
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.227874"], ["updated_at", "2026-01-16 04:58:08.227874"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mUser Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "users"[0m
  [1m[36mPassage Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "passages"[0m
  [1m[36mItem Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "items"[0m
  [1m[36mAssessmentVersion Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "assessment_versions"[0m
  [1m[36mBookCatalog Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "book_catalog" WHERE "book_catalog"."active" = ?[0m  [["active", 1]]
  Rendering layout layouts/admin.html.erb
  Rendering admin/dashboard/index.html.erb within layouts/admin
  Rendered admin/dashboard/index.html.erb within layouts/admin (Duration: 0.8ms | GC: 0.0ms)
  Rendered layout layouts/admin.html.erb (Duration: 13.5ms | GC: 0.0ms)
Completed 200 OK in 69ms (Views: 15.9ms | ActiveRecord: 0.6ms (6 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
Admin::DashboardControllerTest: test_non-admin_cannot_access_dashboard
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.320971"], ["updated_at", "2026-01-16 04:58:08.320971"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.323419"], ["updated_at", "2026-01-16 04:58:08.323419"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/teacher
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 2], ["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:19:in 'RoleAuthorization#require_role!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 2ms (Views: 0.3ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------
UserTest: test_role_must_be_valid
---------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
UserTest: test_admin?_returns_true_for_admin_role
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
UserTest: test_email_optional_must_be_unique_when_present
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "User1"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.335021"], ["updated_at", "2026-01-16 04:58:08.335021"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_student?_returns_true_for_student_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------
UserTest: test_password_authentication_works
--------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.339512"], ["updated_at", "2026-01-16 04:58:08.339512"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------
UserTest: test_valid_user_with_all_required_attributes
------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_role
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_name
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------
UserTest: test_staff?_returns_true_for_admin,_teacher,_school_manager
---------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_teacher?_returns_true_for_teacher_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
SessionsControllerTest: test_successful_login_redirects_to_dashboard
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.349875"], ["updated_at", "2026-01-16 04:58:08.349875"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
SessionsControllerTest: test_logout_clears_session
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.356220"], ["updated_at", "2026-01-16 04:58:08.356220"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 1ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started DELETE "/logout" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by SessionsController#destroy as HTML
Redirected to http://www.example.com/login
Completed 302 Found in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
SessionsControllerTest: test_failed_login_shows_error
-----------------------------------------------------
Started POST "/login" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 10.8ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 12.6ms | GC: 0.0ms)
Completed 422 Unprocessable Content in 25ms (Views: 24.4ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------
SessionsControllerTest: test_get_login_page
-------------------------------------------
Started GET "/login" for 127.0.0.1 at 2026-01-16 13:58:08 +0900
Processing by SessionsController#new as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 0.4ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 0.8ms | GC: 0.0ms)
Completed 200 OK in 2ms (Views: 1.1ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ShortAnswerScorerTest: test_rubric_breakdown_includes_keyword_info
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
ShortAnswerScorerTest: test_handles_comma-separated_answer_key
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
ShortAnswerScorerTest: test_partial_match_scores_partial_points
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ShortAnswerScorerTest: test_no_match_scores_zero
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ShortAnswerScorerTest: test_full_match_scores_full_points
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ScoringServiceTest: test_scores_short_answer_with_keyword_matching
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.4ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:58:08.417159"], ["updated_at", "2026-01-16 04:58:08.417159"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:58:08.434597"], ["updated_at", "2026-01-16 04:58:08.434597"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.437605"], ["updated_at", "2026-01-16 04:58:08.437605"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.440020"], ["updated_at", "2026-01-16 04:58:08.440020"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:58:08.444081"], ["updated_at", "2026-01-16 04:58:08.444081"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.6ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:58:08.445817"], ["updated_at", "2026-01-16 04:58:08.445817"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:58:08.448012"], ["updated_at", "2026-01-16 04:58:08.448012"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:58:08.451847"], ["updated_at", "2026-01-16 04:58:08.451847"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:58:08.458943"], ["updated_at", "2026-01-16 04:58:08.458943"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:58:08.460349"], ["updated_at", "2026-01-16 04:58:08.460349"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:58:08.470957"], ["updated_at", "2026-01-16 04:58:08.470957"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.4ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:58:08.477446"], ["submitted_at", "2026-01-16 04:58:08.477497"], ["status", "submitted"], ["created_at", "2026-01-16 04:58:08.482567"], ["updated_at", "2026-01-16 04:58:08.482567"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"The meaning of the word is clear\""], ["time_spent", nil], ["created_at", "2026-01-16 04:58:08.490608"], ["updated_at", "2026-01-16 04:58:08.490608"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.2ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 04:58:08.526174"], ["updated_at", "2026-01-16 04:58:08.526174"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:58:08.541191"], ["created_at", "2026-01-16 04:58:08.541501"], ["updated_at", "2026-01-16 04:58:08.541501"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.2ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.4ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "C"], ["trait_scores_json", "{\"comprehension\":0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:58:08.551115"], ["created_at", "2026-01-16 04:58:08.551451"], ["updated_at", "2026-01-16 04:58:08.551451"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ScoringServiceTest: test_determines_trait_result
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:58:08.554541"], ["updated_at", "2026-01-16 04:58:08.554541"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.2ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:58:08.555826"], ["updated_at", "2026-01-16 04:58:08.555826"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.558344"], ["updated_at", "2026-01-16 04:58:08.558344"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.560742"], ["updated_at", "2026-01-16 04:58:08.560742"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:58:08.561750"], ["updated_at", "2026-01-16 04:58:08.561750"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.4ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:58:08.563168"], ["updated_at", "2026-01-16 04:58:08.563168"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:58:08.564838"], ["updated_at", "2026-01-16 04:58:08.564838"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:58:08.566055"], ["updated_at", "2026-01-16 04:58:08.566055"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:58:08.567254"], ["updated_at", "2026-01-16 04:58:08.567254"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:58:08.568329"], ["updated_at", "2026-01-16 04:58:08.568329"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:58:08.569517"], ["updated_at", "2026-01-16 04:58:08.569517"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.5ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:58:08.570894"], ["submitted_at", "2026-01-16 04:58:08.570945"], ["status", "submitted"], ["created_at", "2026-01-16 04:58:08.571249"], ["updated_at", "2026-01-16 04:58:08.571249"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.3ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:58:08.573141"], ["updated_at", "2026-01-16 04:58:08.573141"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.3ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning\""], ["time_spent", nil], ["created_at", "2026-01-16 04:58:08.574524"], ["updated_at", "2026-01-16 04:58:08.574524"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:58:08.580078"], ["updated_at", "2026-01-16 04:58:08.580078"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.2ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 04:58:08.582415"], ["updated_at", "2026-01-16 04:58:08.582415"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:58:08.585329"], ["created_at", "2026-01-16 04:58:08.585500"], ["updated_at", "2026-01-16 04:58:08.585500"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "B"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:58:08.587087"], ["created_at", "2026-01-16 04:58:08.587240"], ["updated_at", "2026-01-16 04:58:08.587240"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_incorrectly
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:58:08.590449"], ["updated_at", "2026-01-16 04:58:08.590449"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.3ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:58:08.591599"], ["updated_at", "2026-01-16 04:58:08.591599"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.594095"], ["updated_at", "2026-01-16 04:58:08.594095"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.597184"], ["updated_at", "2026-01-16 04:58:08.597184"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.2ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:58:08.599097"], ["updated_at", "2026-01-16 04:58:08.599097"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:58:08.600500"], ["updated_at", "2026-01-16 04:58:08.600500"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:58:08.601668"], ["updated_at", "2026-01-16 04:58:08.601668"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:58:08.602800"], ["updated_at", "2026-01-16 04:58:08.602800"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:58:08.603884"], ["updated_at", "2026-01-16 04:58:08.603884"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:58:08.604980"], ["updated_at", "2026-01-16 04:58:08.604980"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:58:08.606107"], ["updated_at", "2026-01-16 04:58:08.606107"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:58:08.607138"], ["submitted_at", "2026-01-16 04:58:08.607159"], ["status", "submitted"], ["created_at", "2026-01-16 04:58:08.607378"], ["updated_at", "2026-01-16 04:58:08.607378"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.3ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"A\""], ["time_spent", nil], ["created_at", "2026-01-16 04:58:08.608830"], ["updated_at", "2026-01-16 04:58:08.608830"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.5ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:58:08.611406"], ["updated_at", "2026-01-16 04:58:08.611406"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0}"], ["subskill_scores_json", "{\"main_idea\":0.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:58:08.615083"], ["created_at", "2026-01-16 04:58:08.615279"], ["updated_at", "2026-01-16 04:58:08.615279"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "D"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:58:08.617055"], ["created_at", "2026-01-16 04:58:08.617207"], ["updated_at", "2026-01-16 04:58:08.617207"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_correctly
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.2ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:58:08.619486"], ["updated_at", "2026-01-16 04:58:08.619486"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.3ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:58:08.620598"], ["updated_at", "2026-01-16 04:58:08.620598"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.623011"], ["updated_at", "2026-01-16 04:58:08.623011"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.625360"], ["updated_at", "2026-01-16 04:58:08.625360"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.2ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:58:08.626351"], ["updated_at", "2026-01-16 04:58:08.626351"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:58:08.627489"], ["updated_at", "2026-01-16 04:58:08.627489"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.6ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:58:08.628664"], ["updated_at", "2026-01-16 04:58:08.628664"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:58:08.631036"], ["updated_at", "2026-01-16 04:58:08.631036"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:58:08.632422"], ["updated_at", "2026-01-16 04:58:08.632422"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:58:08.633568"], ["updated_at", "2026-01-16 04:58:08.633568"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:58:08.634716"], ["updated_at", "2026-01-16 04:58:08.634716"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.2ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:58:08.635720"], ["submitted_at", "2026-01-16 04:58:08.635742"], ["status", "submitted"], ["created_at", "2026-01-16 04:58:08.635960"], ["updated_at", "2026-01-16 04:58:08.635960"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.5ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:58:08.637369"], ["updated_at", "2026-01-16 04:58:08.637369"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.6ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:58:08.661524"], ["updated_at", "2026-01-16 04:58:08.661524"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.5ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:58:08.665599"], ["created_at", "2026-01-16 04:58:08.665874"], ["updated_at", "2026-01-16 04:58:08.665874"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:58:08.668596"], ["created_at", "2026-01-16 04:58:08.668795"], ["updated_at", "2026-01-16 04:58:08.668795"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
ScoringServiceTest: test_calculates_metrics_result
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.2ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 04:58:08.671775"], ["updated_at", "2026-01-16 04:58:08.671775"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.2ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 04:58:08.672923"], ["updated_at", "2026-01-16 04:58:08.672923"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.675381"], ["updated_at", "2026-01-16 04:58:08.675381"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 04:58:08.677783"], ["updated_at", "2026-01-16 04:58:08.677783"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.2ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.7ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 04:58:08.678751"], ["updated_at", "2026-01-16 04:58:08.678751"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 04:58:08.681265"], ["updated_at", "2026-01-16 04:58:08.681265"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 04:58:08.682874"], ["updated_at", "2026-01-16 04:58:08.682874"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 04:58:08.684081"], ["updated_at", "2026-01-16 04:58:08.684081"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 04:58:08.685240"], ["updated_at", "2026-01-16 04:58:08.685240"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 04:58:08.686321"], ["updated_at", "2026-01-16 04:58:08.686321"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.2ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 04:58:08.687487"], ["updated_at", "2026-01-16 04:58:08.687487"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 03:58:08.688477"], ["submitted_at", "2026-01-16 04:58:08.688500"], ["status", "submitted"], ["created_at", "2026-01-16 04:58:08.689148"], ["updated_at", "2026-01-16 04:58:08.689148"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 04:58:08.690583"], ["updated_at", "2026-01-16 04:58:08.690583"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning definition\""], ["time_spent", nil], ["created_at", "2026-01-16 04:58:08.691677"], ["updated_at", "2026-01-16 04:58:08.691677"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.2ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 04:58:08.694344"], ["updated_at", "2026-01-16 04:58:08.694344"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 2], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":2,\"match_ratio\":1.0}"], ["created_at", "2026-01-16 04:58:08.696681"], ["updated_at", "2026-01-16 04:58:08.696681"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.2ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 04:58:08.700486"], ["created_at", "2026-01-16 04:58:08.700688"], ["updated_at", "2026-01-16 04:58:08.700688"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 04:58:08.702317"], ["created_at", "2026-01-16 04:58:08.702479"], ["updated_at", "2026-01-16 04:58:08.702479"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
Ai::FeedbackValidatorTest: test_wrong_types_report_errors
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Ai::FeedbackValidatorTest: test_valid_payload_passes_validation
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
Ai::FeedbackValidatorTest: test_missing_required_keys_reports_errors
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
Ai::FeedbackValidatorTest: test_non-hash_payload_reports_error
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_handles_whitespace_in_answer
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------
MultipleChoiceScorerTest: test_correct_answer_scores_full_points
----------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
MultipleChoiceScorerTest: test_handles_nil_answer
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------
MultipleChoiceScorerTest: test_handles_JSON_object_answer_key
-------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------
MultipleChoiceScorerTest: test_case_insensitive_matching
--------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_incorrect_answer_scores_zero
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_role
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
UserTest: test_admin?_returns_true_for_admin_role
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------
UserTest: test_password_authentication_works
--------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.027862"], ["updated_at", "2026-01-16 05:07:20.027862"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
UserTest: test_email_optional_must_be_unique_when_present
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "User1"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.032668"], ["updated_at", "2026-01-16 05:07:20.032668"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.0ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------
UserTest: test_role_must_be_valid
---------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------
UserTest: test_valid_user_with_all_required_attributes
------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_name
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------
UserTest: test_staff?_returns_true_for_admin,_teacher,_school_manager
---------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_student?_returns_true_for_student_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_teacher?_returns_true_for_teacher_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
Admin::DashboardControllerTest: test_unauthenticated_user_cannot_access_dashboard
---------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.211548"], ["updated_at", "2026-01-16 05:07:20.211548"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started GET "/admin" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:13:in 'RoleAuthorization#require_login!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 66ms (Views: 11.2ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
Admin::DashboardControllerTest: test_non-admin_cannot_access_dashboard
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.555534"], ["updated_at", "2026-01-16 05:07:20.555534"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.558779"], ["updated_at", "2026-01-16 05:07:20.558779"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/teacher
Completed 302 Found in 3ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 2], ["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:19:in 'RoleAuthorization#require_role!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 14ms (Views: 0.3ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Admin::DashboardControllerTest: test_admin_can_access_dashboard
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.596765"], ["updated_at", "2026-01-16 05:07:20.596765"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mUser Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "users"[0m
  [1m[36mPassage Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "passages"[0m
  [1m[36mItem Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "items"[0m
  [1m[36mAssessmentVersion Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "assessment_versions"[0m
  [1m[36mBookCatalog Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "book_catalog" WHERE "book_catalog"."active" = ?[0m  [["active", 1]]
  Rendering layout layouts/admin.html.erb
  Rendering admin/dashboard/index.html.erb within layouts/admin
  Rendered admin/dashboard/index.html.erb within layouts/admin (Duration: 0.9ms | GC: 0.0ms)
  Rendered layout layouts/admin.html.erb (Duration: 13.2ms | GC: 0.0ms)
Completed 200 OK in 47ms (Views: 15.7ms | ActiveRecord: 0.5ms (6 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
ShortAnswerScorerTest: test_handles_comma-separated_answer_key
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ShortAnswerScorerTest: test_rubric_breakdown_includes_keyword_info
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ShortAnswerScorerTest: test_no_match_scores_zero
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
ShortAnswerScorerTest: test_partial_match_scores_partial_points
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ShortAnswerScorerTest: test_full_match_scores_full_points
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------
SessionsControllerTest: test_get_login_page
-------------------------------------------
Started GET "/login" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by SessionsController#new as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 9.5ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 11.1ms | GC: 0.0ms)
Completed 200 OK in 24ms (Views: 21.3ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
SessionsControllerTest: test_successful_login_redirects_to_dashboard
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.695395"], ["updated_at", "2026-01-16 05:07:20.695395"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
SessionsControllerTest: test_logout_clears_session
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.701717"], ["updated_at", "2026-01-16 05:07:20.701717"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started DELETE "/logout" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by SessionsController#destroy as HTML
Redirected to http://www.example.com/login
Completed 302 Found in 0ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
SessionsControllerTest: test_failed_login_shows_error
-----------------------------------------------------
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:07:20 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 0.4ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 0.8ms | GC: 0.0ms)
Completed 422 Unprocessable Content in 2ms (Views: 1.2ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ScoringServiceTest: test_determines_trait_result
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:07:20.718894"], ["updated_at", "2026-01-16 05:07:20.718894"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:07:20.735418"], ["updated_at", "2026-01-16 05:07:20.735418"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.738426"], ["updated_at", "2026-01-16 05:07:20.738426"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.740803"], ["updated_at", "2026-01-16 05:07:20.740803"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:07:20.745723"], ["updated_at", "2026-01-16 05:07:20.745723"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:07:20.747362"], ["updated_at", "2026-01-16 05:07:20.747362"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:07:20.748624"], ["updated_at", "2026-01-16 05:07:20.748624"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:07:20.752120"], ["updated_at", "2026-01-16 05:07:20.752120"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:07:20.760504"], ["updated_at", "2026-01-16 05:07:20.760504"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:07:20.761991"], ["updated_at", "2026-01-16 05:07:20.761991"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.5ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:07:20.771143"], ["updated_at", "2026-01-16 05:07:20.771143"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.4ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:07:20.778487"], ["submitted_at", "2026-01-16 05:07:20.778535"], ["status", "submitted"], ["created_at", "2026-01-16 05:07:20.782785"], ["updated_at", "2026-01-16 05:07:20.782785"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.5ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 05:07:20.790896"], ["updated_at", "2026-01-16 05:07:20.790896"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning\""], ["time_spent", nil], ["created_at", "2026-01-16 05:07:20.793195"], ["updated_at", "2026-01-16 05:07:20.793195"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:07:20.840924"], ["updated_at", "2026-01-16 05:07:20.840924"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 05:07:20.843549"], ["updated_at", "2026-01-16 05:07:20.843549"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.4ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:07:20.858388"], ["created_at", "2026-01-16 05:07:20.858885"], ["updated_at", "2026-01-16 05:07:20.858885"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "B"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:07:20.866452"], ["created_at", "2026-01-16 05:07:20.866717"], ["updated_at", "2026-01-16 05:07:20.866717"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ScoringServiceTest: test_scores_short_answer_with_keyword_matching
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:07:20.870328"], ["updated_at", "2026-01-16 05:07:20.870328"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.2ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:07:20.871553"], ["updated_at", "2026-01-16 05:07:20.871553"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.874726"], ["updated_at", "2026-01-16 05:07:20.874726"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.877699"], ["updated_at", "2026-01-16 05:07:20.877699"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:07:20.878892"], ["updated_at", "2026-01-16 05:07:20.878892"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:07:20.880146"], ["updated_at", "2026-01-16 05:07:20.880146"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:07:20.881310"], ["updated_at", "2026-01-16 05:07:20.881310"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:07:20.882438"], ["updated_at", "2026-01-16 05:07:20.882438"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:07:20.883598"], ["updated_at", "2026-01-16 05:07:20.883598"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:07:20.884720"], ["updated_at", "2026-01-16 05:07:20.884720"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:07:20.885994"], ["updated_at", "2026-01-16 05:07:20.885994"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.2ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:07:20.887074"], ["submitted_at", "2026-01-16 05:07:20.887096"], ["status", "submitted"], ["created_at", "2026-01-16 05:07:20.887313"], ["updated_at", "2026-01-16 05:07:20.887313"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"The meaning of the word is clear\""], ["time_spent", nil], ["created_at", "2026-01-16 05:07:20.889029"], ["updated_at", "2026-01-16 05:07:20.889029"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 05:07:20.892444"], ["updated_at", "2026-01-16 05:07:20.892444"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:07:20.895368"], ["created_at", "2026-01-16 05:07:20.895556"], ["updated_at", "2026-01-16 05:07:20.895556"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "C"], ["trait_scores_json", "{\"comprehension\":0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:07:20.897244"], ["created_at", "2026-01-16 05:07:20.897387"], ["updated_at", "2026-01-16 05:07:20.897387"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_correctly
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:07:20.899788"], ["updated_at", "2026-01-16 05:07:20.899788"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:07:20.900961"], ["updated_at", "2026-01-16 05:07:20.900961"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.903575"], ["updated_at", "2026-01-16 05:07:20.903575"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.906311"], ["updated_at", "2026-01-16 05:07:20.906311"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.4ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:07:20.907369"], ["updated_at", "2026-01-16 05:07:20.907369"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:07:20.909095"], ["updated_at", "2026-01-16 05:07:20.909095"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:07:20.910422"], ["updated_at", "2026-01-16 05:07:20.910422"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:07:20.911664"], ["updated_at", "2026-01-16 05:07:20.911664"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:07:20.912760"], ["updated_at", "2026-01-16 05:07:20.912760"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:07:20.913866"], ["updated_at", "2026-01-16 05:07:20.913866"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:07:20.914999"], ["updated_at", "2026-01-16 05:07:20.914999"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:07:20.916003"], ["submitted_at", "2026-01-16 05:07:20.916024"], ["status", "submitted"], ["created_at", "2026-01-16 05:07:20.916238"], ["updated_at", "2026-01-16 05:07:20.916238"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 05:07:20.917668"], ["updated_at", "2026-01-16 05:07:20.917668"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:07:20.920548"], ["updated_at", "2026-01-16 05:07:20.920548"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:07:20.923443"], ["created_at", "2026-01-16 05:07:20.923617"], ["updated_at", "2026-01-16 05:07:20.923617"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:07:20.925749"], ["created_at", "2026-01-16 05:07:20.925942"], ["updated_at", "2026-01-16 05:07:20.925942"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_incorrectly
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:07:20.928302"], ["updated_at", "2026-01-16 05:07:20.928302"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.3ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:07:20.929471"], ["updated_at", "2026-01-16 05:07:20.929471"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.931871"], ["updated_at", "2026-01-16 05:07:20.931871"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.934230"], ["updated_at", "2026-01-16 05:07:20.934230"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.2ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:07:20.935255"], ["updated_at", "2026-01-16 05:07:20.935255"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:07:20.936392"], ["updated_at", "2026-01-16 05:07:20.936392"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.2ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:07:20.937659"], ["updated_at", "2026-01-16 05:07:20.937659"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:07:20.938772"], ["updated_at", "2026-01-16 05:07:20.938772"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:07:20.940002"], ["updated_at", "2026-01-16 05:07:20.940002"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:07:20.942012"], ["updated_at", "2026-01-16 05:07:20.942012"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:07:20.943792"], ["updated_at", "2026-01-16 05:07:20.943792"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.6ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:07:20.945364"], ["submitted_at", "2026-01-16 05:07:20.945391"], ["status", "submitted"], ["created_at", "2026-01-16 05:07:20.945693"], ["updated_at", "2026-01-16 05:07:20.945693"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"A\""], ["time_spent", nil], ["created_at", "2026-01-16 05:07:20.948170"], ["updated_at", "2026-01-16 05:07:20.948170"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.5ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:07:20.973261"], ["updated_at", "2026-01-16 05:07:20.973261"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0}"], ["subskill_scores_json", "{\"main_idea\":0.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:07:20.977284"], ["created_at", "2026-01-16 05:07:20.977492"], ["updated_at", "2026-01-16 05:07:20.977492"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "D"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:07:20.979223"], ["created_at", "2026-01-16 05:07:20.979388"], ["updated_at", "2026-01-16 05:07:20.979388"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
ScoringServiceTest: test_calculates_metrics_result
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.2ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:07:20.982529"], ["updated_at", "2026-01-16 05:07:20.982529"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.2ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:07:20.983695"], ["updated_at", "2026-01-16 05:07:20.983695"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.986177"], ["updated_at", "2026-01-16 05:07:20.986177"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:07:20.988488"], ["updated_at", "2026-01-16 05:07:20.988488"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:07:20.989452"], ["updated_at", "2026-01-16 05:07:20.989452"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.8ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (1.0ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:07:20.990822"], ["updated_at", "2026-01-16 05:07:20.990822"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:07:20.993232"], ["updated_at", "2026-01-16 05:07:20.993232"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:07:20.994554"], ["updated_at", "2026-01-16 05:07:20.994554"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:07:20.995693"], ["updated_at", "2026-01-16 05:07:20.995693"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:07:20.996737"], ["updated_at", "2026-01-16 05:07:20.996737"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:07:20.997996"], ["updated_at", "2026-01-16 05:07:20.997996"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:07:20.999058"], ["submitted_at", "2026-01-16 05:07:20.999081"], ["status", "submitted"], ["created_at", "2026-01-16 05:07:20.999313"], ["updated_at", "2026-01-16 05:07:20.999313"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.4ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.6ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 05:07:21.000757"], ["updated_at", "2026-01-16 05:07:21.000757"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning definition\""], ["time_spent", nil], ["created_at", "2026-01-16 05:07:21.002290"], ["updated_at", "2026-01-16 05:07:21.002290"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.0ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.2ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:07:21.004901"], ["updated_at", "2026-01-16 05:07:21.004901"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.2ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 2], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":2,\"match_ratio\":1.0}"], ["created_at", "2026-01-16 05:07:21.006816"], ["updated_at", "2026-01-16 05:07:21.006816"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.2ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:07:21.010699"], ["created_at", "2026-01-16 05:07:21.010900"], ["updated_at", "2026-01-16 05:07:21.010900"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.2ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:07:21.012463"], ["created_at", "2026-01-16 05:07:21.012603"], ["updated_at", "2026-01-16 05:07:21.012603"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
Ai::FeedbackValidatorTest: test_non-hash_payload_reports_error
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
Ai::FeedbackValidatorTest: test_wrong_types_report_errors
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Ai::FeedbackValidatorTest: test_valid_payload_passes_validation
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
Ai::FeedbackValidatorTest: test_missing_required_keys_reports_errors
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------
MultipleChoiceScorerTest: test_correct_answer_scores_full_points
----------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_incorrect_answer_scores_zero
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
MultipleChoiceScorerTest: test_handles_nil_answer
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_handles_whitespace_in_answer
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------
MultipleChoiceScorerTest: test_handles_JSON_object_answer_key
-------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------
MultipleChoiceScorerTest: test_case_insensitive_matching
--------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mActiveRecord::InternalMetadata Load (0.3ms)[0m  [1m[34mSELECT * FROM "ar_internal_metadata" WHERE "ar_internal_metadata"."key" = ? ORDER BY "ar_internal_metadata"."key" ASC LIMIT 1[0m  [[nil, "schema_sha1"]]
  [1m[36mActiveRecord::SchemaMigration Load (0.1ms)[0m  [1m[34mSELECT "schema_migrations"."version" FROM "schema_migrations" ORDER BY "schema_migrations"."version" ASC[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ScoringServiceTest: test_scores_short_answer_with_keyword_matching
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.5ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:16:02.683992"], ["updated_at", "2026-01-16 05:16:02.683992"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:16:02.710186"], ["updated_at", "2026-01-16 05:16:02.710186"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:02.751722"], ["updated_at", "2026-01-16 05:16:02.751722"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:02.754793"], ["updated_at", "2026-01-16 05:16:02.754793"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.4ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:16:02.762210"], ["updated_at", "2026-01-16 05:16:02.762210"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.5ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:16:02.794644"], ["updated_at", "2026-01-16 05:16:02.794644"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.6ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:16:02.796767"], ["updated_at", "2026-01-16 05:16:02.796767"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:16:02.805990"], ["updated_at", "2026-01-16 05:16:02.805990"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:16:02.815048"], ["updated_at", "2026-01-16 05:16:02.815048"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:16:02.816572"], ["updated_at", "2026-01-16 05:16:02.816572"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:16:02.827004"], ["updated_at", "2026-01-16 05:16:02.827004"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.4ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:16:02.834604"], ["submitted_at", "2026-01-16 05:16:02.834655"], ["status", "submitted"], ["created_at", "2026-01-16 05:16:02.839167"], ["updated_at", "2026-01-16 05:16:02.839167"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"The meaning of the word is clear\""], ["time_spent", nil], ["created_at", "2026-01-16 05:16:02.848854"], ["updated_at", "2026-01-16 05:16:02.848854"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 05:16:02.892338"], ["updated_at", "2026-01-16 05:16:02.892338"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.0ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.4ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:16:02.908720"], ["created_at", "2026-01-16 05:16:02.909054"], ["updated_at", "2026-01-16 05:16:02.909054"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.4ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "C"], ["trait_scores_json", "{\"comprehension\":0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:16:02.917870"], ["created_at", "2026-01-16 05:16:02.918182"], ["updated_at", "2026-01-16 05:16:02.918182"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ScoringServiceTest: test_determines_trait_result
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.3ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:16:02.924651"], ["updated_at", "2026-01-16 05:16:02.924651"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.3ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:16:02.926111"], ["updated_at", "2026-01-16 05:16:02.926111"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.1ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:02.928960"], ["updated_at", "2026-01-16 05:16:02.928960"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:02.932089"], ["updated_at", "2026-01-16 05:16:02.932089"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.3ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:16:02.933549"], ["updated_at", "2026-01-16 05:16:02.933549"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:16:02.935054"], ["updated_at", "2026-01-16 05:16:02.935054"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.3ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:16:02.936462"], ["updated_at", "2026-01-16 05:16:02.936462"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:16:02.937791"], ["updated_at", "2026-01-16 05:16:02.937791"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.3ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:16:02.939153"], ["updated_at", "2026-01-16 05:16:02.939153"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.2ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:16:02.940431"], ["updated_at", "2026-01-16 05:16:02.940431"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.3ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:16:02.941754"], ["updated_at", "2026-01-16 05:16:02.941754"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.3ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:16:02.942970"], ["submitted_at", "2026-01-16 05:16:02.942994"], ["status", "submitted"], ["created_at", "2026-01-16 05:16:02.943248"], ["updated_at", "2026-01-16 05:16:02.943248"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.2ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 05:16:02.944956"], ["updated_at", "2026-01-16 05:16:02.944956"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning\""], ["time_spent", nil], ["created_at", "2026-01-16 05:16:02.946227"], ["updated_at", "2026-01-16 05:16:02.946227"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:16:02.953223"], ["updated_at", "2026-01-16 05:16:02.953223"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":1,\"match_ratio\":0.5}"], ["created_at", "2026-01-16 05:16:02.955701"], ["updated_at", "2026-01-16 05:16:02.955701"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.3ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":50.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:16:02.959558"], ["created_at", "2026-01-16 05:16:02.959816"], ["updated_at", "2026-01-16 05:16:02.959816"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.5ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "B"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":50.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:16:02.961992"], ["created_at", "2026-01-16 05:16:02.962252"], ["updated_at", "2026-01-16 05:16:02.962252"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.2ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_correctly
---------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.5ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:16:02.968308"], ["updated_at", "2026-01-16 05:16:02.968308"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:16:02.970357"], ["updated_at", "2026-01-16 05:16:02.970357"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:02.973805"], ["updated_at", "2026-01-16 05:16:02.973805"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:02.977021"], ["updated_at", "2026-01-16 05:16:02.977021"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.4ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:16:02.978659"], ["updated_at", "2026-01-16 05:16:02.978659"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.5ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:16:02.980988"], ["updated_at", "2026-01-16 05:16:02.980988"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.7ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:16:02.983259"], ["updated_at", "2026-01-16 05:16:02.983259"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:16:02.985963"], ["updated_at", "2026-01-16 05:16:02.985963"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:16:02.987994"], ["updated_at", "2026-01-16 05:16:02.987994"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:16:02.989785"], ["updated_at", "2026-01-16 05:16:02.989785"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:16:02.991777"], ["updated_at", "2026-01-16 05:16:02.991777"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.4ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:16:02.993510"], ["submitted_at", "2026-01-16 05:16:02.993547"], ["status", "submitted"], ["created_at", "2026-01-16 05:16:02.994021"], ["updated_at", "2026-01-16 05:16:02.994021"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 05:16:02.996076"], ["updated_at", "2026-01-16 05:16:02.996076"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:16:03.002288"], ["updated_at", "2026-01-16 05:16:03.002288"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.2ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.4ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:16:03.007299"], ["created_at", "2026-01-16 05:16:03.007692"], ["updated_at", "2026-01-16 05:16:03.007692"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.3ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:16:03.010455"], ["created_at", "2026-01-16 05:16:03.010716"], ["updated_at", "2026-01-16 05:16:03.010716"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
ScoringServiceTest: test_scores_multiple_choice_incorrectly
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.7ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:16:03.013875"], ["updated_at", "2026-01-16 05:16:03.013875"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.4ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:16:03.016156"], ["updated_at", "2026-01-16 05:16:03.016156"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.019525"], ["updated_at", "2026-01-16 05:16:03.019525"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.022730"], ["updated_at", "2026-01-16 05:16:03.022730"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.4ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:16:03.024218"], ["updated_at", "2026-01-16 05:16:03.024218"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.4ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:16:03.025995"], ["updated_at", "2026-01-16 05:16:03.025995"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.5ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:16:03.027735"], ["updated_at", "2026-01-16 05:16:03.027735"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:16:03.029856"], ["updated_at", "2026-01-16 05:16:03.029856"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:16:03.032315"], ["updated_at", "2026-01-16 05:16:03.032315"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:16:03.034178"], ["updated_at", "2026-01-16 05:16:03.034178"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.5ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:16:03.036101"], ["updated_at", "2026-01-16 05:16:03.036101"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.5ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:16:03.037755"], ["submitted_at", "2026-01-16 05:16:03.037795"], ["status", "submitted"], ["created_at", "2026-01-16 05:16:03.038199"], ["updated_at", "2026-01-16 05:16:03.038199"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"A\""], ["time_spent", nil], ["created_at", "2026-01-16 05:16:03.040991"], ["updated_at", "2026-01-16 05:16:03.040991"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.3ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 0], ["is_correct", 0], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:16:03.045336"], ["updated_at", "2026-01-16 05:16:03.045336"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.0ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.1ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" = ?[0m  [["id", 1]]
  [1m[36mMetricsResult Load (0.2ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.4ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":0.0}"], ["subskill_scores_json", "{\"main_idea\":0.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:16:03.049854"], ["created_at", "2026-01-16 05:16:03.050109"], ["updated_at", "2026-01-16 05:16:03.050109"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.1ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.5ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "D"], ["trait_scores_json", "{\"comprehension\":0.0,\"vocabulary\":0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:16:03.052410"], ["created_at", "2026-01-16 05:16:03.052688"], ["updated_at", "2026-01-16 05:16:03.052688"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
ScoringServiceTest: test_calculates_metrics_result
--------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchool Create (0.5ms)[0m  [1m[32mINSERT INTO "schools" ("name", "created_at", "updated_at") VALUES (?, ?, ?) RETURNING "id"[0m  [["name", "Test School"], ["created_at", "2026-01-16 05:16:03.056267"], ["updated_at", "2026-01-16 05:16:03.056267"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSchoolClass Create (0.6ms)[0m  [1m[32mINSERT INTO "classes" ("school_id", "grade", "name", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["grade", "3"], ["name", "Class A"], ["created_at", "2026-01-16 05:16:03.058514"], ["updated_at", "2026-01-16 05:16:03.058514"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.062709"], ["updated_at", "2026-01-16 05:16:03.062709"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Student User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.067418"], ["updated_at", "2026-01-16 05:16:03.067418"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mPassage Create (0.6ms)[0m  [1m[32mINSERT INTO "passages" ("title", "text", "grade_band", "tags_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["title", "Test Passage"], ["text", "Test content"], ["grade_band", nil], ["tags_json", nil], ["created_at", "2026-01-16 05:16:03.069545"], ["updated_at", "2026-01-16 05:16:03.069545"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.5ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "multiple_choice"], ["domain", "comprehension"], ["subskill", "main_idea"], ["difficulty", nil], ["prompt", "What is the main idea?"], ["choices_json", "\"[\\\"A\\\", \\\"B\\\", \\\"C\\\", \\\"D\\\"]\""], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 1], ["created_at", "2026-01-16 05:16:03.072032"], ["updated_at", "2026-01-16 05:16:03.072032"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mItem Create (0.5ms)[0m  [1m[32mINSERT INTO "items" ("passage_id", "item_type", "domain", "subskill", "difficulty", "prompt", "choices_json", "answer_key_json", "rubric_json", "points", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["passage_id", 1], ["item_type", "short_answer"], ["domain", "vocabulary"], ["subskill", "context_clues"], ["difficulty", nil], ["prompt", "Define the word."], ["choices_json", nil], ["answer_key_json", "[FILTERED]"], ["rubric_json", nil], ["points", 2], ["created_at", "2026-01-16 05:16:03.074644"], ["updated_at", "2026-01-16 05:16:03.074644"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersion Create (0.5ms)[0m  [1m[32mINSERT INTO "assessment_versions" ("name", "status", "published_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["name", "Test Version"], ["status", "published"], ["published_at", nil], ["created_at", "2026-01-16 05:16:03.076852"], ["updated_at", "2026-01-16 05:16:03.076852"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.4ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 1], ["order_no", 1], ["created_at", "2026-01-16 05:16:03.078821"], ["updated_at", "2026-01-16 05:16:03.078821"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mAssessmentVersionItem Create (0.6ms)[0m  [1m[32mINSERT INTO "assessment_version_items" ("assessment_version_id", "item_id", "order_no", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?) RETURNING "id"[0m  [["assessment_version_id", 1], ["item_id", 2], ["order_no", 2], ["created_at", "2026-01-16 05:16:03.081143"], ["updated_at", "2026-01-16 05:16:03.081143"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSession Create (0.4ms)[0m  [1m[32mINSERT INTO "sessions" ("school_id", "class_id", "assessment_version_id", "created_by_teacher_id", "start_at", "end_at", "status", "access_code", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["school_id", 1], ["class_id", 1], ["assessment_version_id", 1], ["created_by_teacher_id", 1], ["start_at", nil], ["end_at", nil], ["status", "active"], ["access_code", "ABC123"], ["created_at", "2026-01-16 05:16:03.083853"], ["updated_at", "2026-01-16 05:16:03.083853"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mSubmission Create (0.6ms)[0m  [1m[32mINSERT INTO "submissions" ("session_id", "student_id", "started_at", "submitted_at", "status", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["session_id", 1], ["student_id", 2], ["started_at", "2026-01-16 04:16:03.085593"], ["submitted_at", "2026-01-16 05:16:03.085636"], ["status", "submitted"], ["created_at", "2026-01-16 05:16:03.086092"], ["updated_at", "2026-01-16 05:16:03.086092"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.4ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["answer_json", "\"B\""], ["time_spent", nil], ["created_at", "2026-01-16 05:16:03.088725"], ["updated_at", "2026-01-16 05:16:03.088725"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mResponse Create (0.5ms)[0m  [1m[32mINSERT INTO "responses" ("submission_id", "item_id", "answer_json", "time_spent", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["answer_json", "\"meaning definition\""], ["time_spent", nil], ["created_at", "2026-01-16 05:16:03.090739"], ["updated_at", "2026-01-16 05:16:03.090739"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mResponse Load (0.1ms)[0m  [1m[34mSELECT "responses".* FROM "responses" WHERE "responses"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mScoringResult Load (0.2ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.8ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 1], ["score", 1], ["is_correct", 1], ["rubric_breakdown_json", nil], ["created_at", "2026-01-16 05:16:03.096680"], ["updated_at", "2026-01-16 05:16:03.096680"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ? AND "scoring_results"."item_id" = ? LIMIT ?[0m  [["submission_id", 1], ["item_id", 2], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mScoringResult Create (0.4ms)[0m  [1m[32mINSERT INTO "scoring_results" ("submission_id", "item_id", "score", "is_correct", "rubric_breakdown_json", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["item_id", 2], ["score", 2], ["is_correct", 1], ["rubric_breakdown_json", "{\"total_keywords\":2,\"matched_keywords\":2,\"match_ratio\":1.0}"], ["created_at", "2026-01-16 05:16:03.100534"], ["updated_at", "2026-01-16 05:16:03.100534"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mScoringResult Load (0.1ms)[0m  [1m[34mSELECT "scoring_results".* FROM "scoring_results" WHERE "scoring_results"."submission_id" = ?[0m  [["submission_id", 1]]
  [1m[36mItem Load (0.2ms)[0m  [1m[34mSELECT "items".* FROM "items" WHERE "items"."id" IN (?, ?)[0m  [["id", 1], ["id", 2]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mCACHE MetricsResult Load (0.0ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mMetricsResult Create (0.6ms)[0m  [1m[32mINSERT INTO "metrics_results" ("submission_id", "domain_scores_json", "subskill_scores_json", "percentile_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["domain_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0}"], ["subskill_scores_json", "{\"main_idea\":100.0,\"context_clues\":100.0}"], ["percentile_json", "{\"overall\":0}"], ["computed_at", "2026-01-16 05:16:03.106695"], ["created_at", "2026-01-16 05:16:03.107097"], ["updated_at", "2026-01-16 05:16:03.107097"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTraitResult Load (0.2ms)[0m  [1m[34mSELECT "trait_results".* FROM "trait_results" WHERE "trait_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mTraitResult Create (0.4ms)[0m  [1m[32mINSERT INTO "trait_results" ("submission_id", "trait_type", "trait_scores_json", "computed_at", "created_at", "updated_at") VALUES (?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["submission_id", 1], ["trait_type", "A"], ["trait_scores_json", "{\"comprehension\":100.0,\"vocabulary\":100.0,\"inference\":0,\"analysis\":0}"], ["computed_at", "2026-01-16 05:16:03.110417"], ["created_at", "2026-01-16 05:16:03.110813"], ["updated_at", "2026-01-16 05:16:03.110813"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mSubmission Load (0.1ms)[0m  [1m[34mSELECT "submissions".* FROM "submissions" WHERE "submissions"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mMetricsResult Load (0.1ms)[0m  [1m[34mSELECT "metrics_results".* FROM "metrics_results" WHERE "metrics_results"."submission_id" = ? LIMIT ?[0m  [["submission_id", 1], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
SessionsControllerTest: test_successful_login_redirects_to_dashboard
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.6ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.301139"], ["updated_at", "2026-01-16 05:16:03.301139"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 67ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------
SessionsControllerTest: test_get_login_page
-------------------------------------------
Started GET "/login" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by SessionsController#new as HTML
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 12.3ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 30.1ms | GC: 0.0ms)
Completed 200 OK in 83ms (Views: 53.6ms | ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------
SessionsControllerTest: test_logout_clears_session
--------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.831715"], ["updated_at", "2026-01-16 05:16:03.831715"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started DELETE "/logout" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by SessionsController#destroy as HTML
Redirected to http://www.example.com/login
Completed 302 Found in 16ms (ActiveRecord: 0.0ms (0 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
SessionsControllerTest: test_failed_login_shows_error
-----------------------------------------------------
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  Rendering layout layouts/application.html.erb
  Rendering sessions/new.html.erb within layouts/application
  Rendered sessions/new.html.erb within layouts/application (Duration: 0.5ms | GC: 0.0ms)
  Rendered layout layouts/application.html.erb (Duration: 1.1ms | GC: 0.0ms)
Completed 422 Unprocessable Content in 2ms (Views: 1.5ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_incorrect_answer_scores_zero
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------
MultipleChoiceScorerTest: test_correct_answer_scores_full_points
----------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------------
MultipleChoiceScorerTest: test_handles_whitespace_in_answer
-----------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------------------
MultipleChoiceScorerTest: test_handles_JSON_object_answer_key
-------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
MultipleChoiceScorerTest: test_handles_nil_answer
-------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------
MultipleChoiceScorerTest: test_case_insensitive_matching
--------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------------------
Admin::DashboardControllerTest: test_unauthenticated_user_cannot_access_dashboard
---------------------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.872429"], ["updated_at", "2026-01-16 05:16:03.872429"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started GET "/admin" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" IS NULL LIMIT ?[0m  [["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:13:in 'RoleAuthorization#require_login!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 5ms (Views: 3.5ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
----------------------------------------------------------------------
Admin::DashboardControllerTest: test_non-admin_cannot_access_dashboard
----------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.4ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.889815"], ["updated_at", "2026-01-16 05:16:03.889815"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "teacher"], ["status", "active"], ["name", "Teacher"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.916032"], ["updated_at", "2026-01-16 05:16:03.916032"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/teacher
Completed 302 Found in 2ms (ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 2], ["LIMIT", 1]]
rescue_from handled RoleAuthorization::AccessDenied (RoleAuthorization::AccessDenied) - app/controllers/concerns/role_authorization.rb:19:in 'RoleAuthorization#require_role!'
  Rendering text template
  Rendered text template (Duration: 0.0ms | GC: 0.0ms)
Completed 403 Forbidden in 2ms (Views: 0.3ms | ActiveRecord: 0.1ms (1 query, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Admin::DashboardControllerTest: test_admin_can_access_dashboard
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "admin"], ["status", "active"], ["name", "Admin"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.930160"], ["updated_at", "2026-01-16 05:16:03.930160"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
Started POST "/login" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by SessionsController#create as HTML
  Parameters: {"email" => "[FILTERED]", "password" => "[FILTERED]"}
  [1m[36mUser Load (0.2ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
Redirected to http://www.example.com/admin
Completed 302 Found in 2ms (ActiveRecord: 0.2ms (1 query, 0 cached) | GC: 0.0ms)
Started GET "/admin" for 127.0.0.1 at 2026-01-16 14:16:03 +0900
Processing by Admin::DashboardController#index as HTML
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT "users".* FROM "users" WHERE "users"."id" = ? LIMIT ?[0m  [["id", 1], ["LIMIT", 1]]
  [1m[36mUser Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "users"[0m
  [1m[36mPassage Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "passages"[0m
  [1m[36mItem Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "items"[0m
  [1m[36mAssessmentVersion Count (0.0ms)[0m  [1m[34mSELECT COUNT(*) FROM "assessment_versions"[0m
  [1m[36mBookCatalog Count (0.1ms)[0m  [1m[34mSELECT COUNT(*) FROM "book_catalog" WHERE "book_catalog"."active" = ?[0m  [["active", 1]]
  Rendering layout layouts/admin.html.erb
  Rendering admin/dashboard/index.html.erb within layouts/admin
  Rendered admin/dashboard/index.html.erb within layouts/admin (Duration: 1.2ms | GC: 0.0ms)
  Rendered layout layouts/admin.html.erb (Duration: 3.8ms | GC: 0.0ms)
Completed 200 OK in 17ms (Views: 7.1ms | ActiveRecord: 0.6ms (6 queries, 0 cached) | GC: 0.0ms)
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
Ai::FeedbackValidatorTest: test_wrong_types_report_errors
---------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
Ai::FeedbackValidatorTest: test_non-hash_payload_reports_error
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
Ai::FeedbackValidatorTest: test_valid_payload_passes_validation
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------------
Ai::FeedbackValidatorTest: test_missing_required_keys_reports_errors
--------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------
UserTest: test_valid_user_with_all_required_attributes
------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------
UserTest: test_password_authentication_works
--------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.3ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.2ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "Test User"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.971368"], ["updated_at", "2026-01-16 05:16:03.971368"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_name
-----------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
UserTest: test_email_optional_must_be_unique_when_present
---------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mSAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.5ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mUser Create (0.3ms)[0m  [1m[32mINSERT INTO "users" ("role", "status", "name", "email_optional", "created_at", "updated_at", "password_digest") VALUES (?, ?, ?, ?, ?, ?, ?) RETURNING "id"[0m  [["role", "student"], ["status", "active"], ["name", "User1"], ["email_optional", "[FILTERED]"], ["created_at", "2026-01-16 05:16:03.984395"], ["updated_at", "2026-01-16 05:16:03.984395"], ["password_digest", "[FILTERED]"]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[35mRELEASE SAVEPOINT active_record_1[0m
  [1m[36mUser Exists? (0.2ms)[0m  [1m[34mSELECT 1 AS one FROM "users" WHERE "users"."email_optional" = ? LIMIT ?[0m  [["email_optional", "[FILTERED]"], ["LIMIT", 1]]
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-------------------------------------------------
UserTest: test_admin?_returns_true_for_admin_role
-------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------
UserTest: test_role_must_be_valid
---------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_student?_returns_true_for_student_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------------
UserTest: test_staff?_returns_true_for_admin,_teacher,_school_manager
---------------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------
UserTest: test_invalid_without_role
-----------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
-----------------------------------------------------
UserTest: test_teacher?_returns_true_for_teacher_role
-----------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------------------------
ShortAnswerScorerTest: test_rubric_breakdown_includes_keyword_info
------------------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
--------------------------------------------------------------
ShortAnswerScorerTest: test_handles_comma-separated_answer_key
--------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
------------------------------------------------
ShortAnswerScorerTest: test_no_match_scores_zero
------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------------
ShortAnswerScorerTest: test_partial_match_scores_partial_points
---------------------------------------------------------------
  [1m[36mTRANSACTION (0.1ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[36mBEGIN deferred TRANSACTION[0m
---------------------------------------------------------
ShortAnswerScorerTest: test_full_match_scores_full_points
---------------------------------------------------------
  [1m[36mTRANSACTION (0.0ms)[0m  [1m[31mROLLBACK TRANSACTION[0m
